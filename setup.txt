import base64
exec(base64.b64decode(b'aW1wb3J0IHRlbGVib3QKZnJvbSB0ZWxlYm90IGltcG9ydCB0eXBlcwppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHRpbWUKaW1wb3J0IHNxbGl0ZTMKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgcmFuZG9tCmltcG9ydCBzdHJpbmcKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKCgoKREVWRUxPUEVSX0xJTksgPSBmImh0dHBzOi8vdC5tZS97QURNSU5fVVNFUk5BTUV9IgojIEFQSSBVUkxzCk5VTUJFUl9BUElfVVJMID0gImh0dHBzOi8vYXBpLmI3N2JmOTExLndvcmtlcnMuZGV2L21vYmlsZT9udW1iZXI9e30iClZFSElDTEVfQVBJX1VSTF8xID0gImh0dHBzOi8vYXBpLmI3N2JmOTExLndvcmtlcnMuZGV2L3ZlaGljbGU/cmVnaXN0cmF0aW9uPXt9IgpWRUhJQ0xFX0FQSV9VUkxfMiA9ICJodHRwczovL2FzLXJ1YnktcGkudmVyY2VsLmFwcC92ZWhpY2xlP3JjPXt9IgpBQURIQUFSX0FQSV9VUkwgPSAiaHR0cHM6Ly9hcGkuYjc3YmY5MTEud29ya2Vycy5kZXYvYWFkaGFhcj9pZD17fSIKCmJvdCA9IHRlbGVib3QuVGVsZUJvdChCT1RfVE9LRU4pCmJyb2FkY2FzdF9zdG9yYWdlID0ge30KCmRlZiBnZW5lcmF0ZV9icm9hZGNhc3RfaWQoKToKICAgICIiIkdlbmVyYXRlIHJhbmRvbSBicm9hZGNhc3QgSUQiIiIKICAgIHJldHVybiAnJy5qb2luKHJhbmRvbS5jaG9pY2VzKHN0cmluZy5hc2NpaV9sZXR0ZXJzICsgc3RyaW5nLmRpZ2l0cywgaz04KSkKCmRlZiBpbml0X2RiKCk6CiAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KCd1c2Vycy5kYicpCiAgICBjID0gY29ubi5jdXJzb3IoKQogICAgIyBDcmVhdGUgdXNlcnMgdGFibGUKICAgIGMuZXhlY3V0ZSgnJydDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB1c2VycwogICAgICAgICAgICAgICAgICh1c2VyX2lkIElOVEVHRVIgUFJJTUFSWSBLRVksIHVzZXJuYW1lIFRFWFQsIGZpcnN0X25hbWUgVEVYVCwgbGFzdF9uYW1lIFRFWFQsIGRhdGVfam9pbmVkIFRJTUVTVEFNUCBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QKScnJykKICAgICMgQ3JlYXRlIGJhbm5lZF91c2VycyB0YWJsZQogICAgYy5leGVjdXRlKCcnJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGJhbm5lZF91c2VycwogICAgICAgICAgICAgICAgICh1c2VyX2lkIElOVEVHRVIgUFJJTUFSWSBLRVksIAogICAgICAgICAgICAgICAgICB1c2VybmFtZSBURVhULAogICAgICAgICAgICAgICAgICBmaXJzdF9uYW1lIFRFWFQsCiAgICAgICAgICAgICAgICAgIGxhc3RfbmFtZSBURVhULAogICAgICAgICAgICAgICAgICBiYW5uZWRfYXQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgIGJhbm5lZF9ieSBJTlRFR0VSLAogICAgICAgICAgICAgICAgICByZWFzb24gVEVYVCBERUZBVUxUICdObyByZWFzb24gcHJvdmlkZWQnKScnJykKICAgIGNvbm4uY29tbWl0KCkKICAgIGNvbm4uY2xvc2UoKQoKZGVmIHNhdmVfdXNlcih1c2VyX2lkLCB1c2VybmFtZSwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lKToKICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoJ3VzZXJzLmRiJykKICAgIGMgPSBjb25uLmN1cnNvcigpCiAgICBjLmV4ZWN1dGUoJycnSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyB1c2VycyAodXNlcl9pZCwgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSkgCiAgICAgICAgICAgICAgICAgVkFMVUVTICg/LCA/LCA/LCA/KScnJywgKHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUpKQogICAgY29ubi5jb21taXQoKQogICAgY29ubi5jbG9zZSgpCgpkZWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAiIiJDaGVjayBpZiB1c2VyIGlzIGJhbm5lZCIiIgogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnU0VMRUNUICogRlJPTSBiYW5uZWRfdXNlcnMgV0hFUkUgdXNlcl9pZCA9ID8nLCAodXNlcl9pZCwpKQogICAgcmVzdWx0ID0gYy5mZXRjaG9uZSgpCiAgICBjb25uLmNsb3NlKCkKICAgIHJldHVybiByZXN1bHQgaXMgbm90IE5vbmUKCmRlZiBnZXRfYmFubmVkX3VzZXJfaW5mbyh1c2VyX2lkKToKICAgICIiIkdldCBiYW5uZWQgdXNlciBpbmZvcm1hdGlvbiIiIgogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnU0VMRUNUICogRlJPTSBiYW5uZWRfdXNlcnMgV0hFUkUgdXNlcl9pZCA9ID8nLCAodXNlcl9pZCwpKQogICAgcmVzdWx0ID0gYy5mZXRjaG9uZSgpCiAgICBjb25uLmNsb3NlKCkKICAgIHJldHVybiByZXN1bHQKCmRlZiBiYW5fdXNlcih1c2VyX2lkLCB1c2VybmFtZSwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBiYW5uZWRfYnksIHJlYXNvbj1Ob25lKToKICAgICIiIkJhbiBhIHVzZXIiIiIKICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoJ3VzZXJzLmRiJykKICAgIGMgPSBjb25uLmN1cnNvcigpCiAgICBjLmV4ZWN1dGUoJycnSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBiYW5uZWRfdXNlcnMgCiAgICAgICAgICAgICAgICAgKHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIGJhbm5lZF9ieSwgcmVhc29uKSAKICAgICAgICAgICAgICAgICBWQUxVRVMgKD8sID8sID8sID8sID8sID8pJycnLCAKICAgICAgICAgICAgICAgICAodXNlcl9pZCwgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgYmFubmVkX2J5LCByZWFzb24pKQogICAgY29ubi5jb21taXQoKQogICAgY29ubi5jbG9zZSgpCiAgICByZXR1cm4gVHJ1ZQoKZGVmIHVuYmFuX3VzZXIodXNlcl9pZCk6CiAgICAiIiJVbmJhbiBhIHVzZXIiIiIKICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoJ3VzZXJzLmRiJykKICAgIGMgPSBjb25uLmN1cnNvcigpCiAgICBjLmV4ZWN1dGUoJ0RFTEVURSBGUk9NIGJhbm5lZF91c2VycyBXSEVSRSB1c2VyX2lkID0gPycsICh1c2VyX2lkLCkpCiAgICBjb25uLmNvbW1pdCgpCiAgICBhZmZlY3RlZCA9IGMucm93Y291bnQKICAgIGNvbm4uY2xvc2UoKQogICAgcmV0dXJuIGFmZmVjdGVkID4gMAoKZGVmIGdldF9hbGxfYmFubmVkX3VzZXJzKCk6CiAgICAiIiJHZXQgYWxsIGJhbm5lZCB1c2VycyIiIgogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnU0VMRUNUIHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIGJhbm5lZF9hdCBGUk9NIGJhbm5lZF91c2VycycpCiAgICB1c2VycyA9IGMuZmV0Y2hhbGwoKQogICAgY29ubi5jbG9zZSgpCiAgICByZXR1cm4gdXNlcnMKCmRlZiBnZXRfYWxsX3VzZXJzKCk6CiAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KCd1c2Vycy5kYicpCiAgICBjID0gY29ubi5jdXJzb3IoKQogICAgYy5leGVjdXRlKCdTRUxFQ1QgdXNlcl9pZCBGUk9NIHVzZXJzJykKICAgIHVzZXJzID0gW3Jvd1swXSBmb3Igcm93IGluIGMuZmV0Y2hhbGwoKV0KICAgIGNvbm4uY2xvc2UoKQogICAgcmV0dXJuIHVzZXJzCgppbml0X2RiKCkKCmRlZiBmZXRjaF9udW1iZXJfaW5mb19mcm9tX2FwaShtb2JpbGVfbnVtYmVyKToKICAgICIiIgogICAgRmV0Y2ggbnVtYmVyIGluZm8gZnJvbSBwcmltYXJ5IEFQSSAtIFNpbXBsaWZpZWQgZGlyZWN0IHJlc3BvbnNlCiAgICAiIiIKICAgIHRyeToKICAgICAgICBhcGlfdXJsID0gTlVNQkVSX0FQSV9VUkwuZm9ybWF0KG1vYmlsZV9udW1iZXIpCiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoYXBpX3VybCwgdGltZW91dD0xMCkKICAgICAgICAKICAgICAgICAjIFN0b3JlIHJhdyByZXNwb25zZSBmb3IgZGVidWdnaW5nCiAgICAgICAgcmF3X3Jlc3BvbnNlID0gcmVzcG9uc2UudGV4dAogICAgICAgIAogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJldHVybiB0aGUgY29tcGxldGUgQVBJIHJlc3BvbnNlIGZvciBkZWJ1Z2dpbmcKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAic291cmNlIjogIkFQSSIsCiAgICAgICAgICAgICAgICAgICAgInJhd19yZXNwb25zZSI6IHJhd19yZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAicGFyc2VkX2RhdGEiOiBkYXRhLAogICAgICAgICAgICAgICAgICAgICJpc19qc29uIjogVHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgIyBJZiByZXNwb25zZSBpcyBub3QgSlNPTiwgcmV0dXJuIGFzIHRleHQKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAic291cmNlIjogIkFQSSIsCiAgICAgICAgICAgICAgICAgICAgInJhd19yZXNwb25zZSI6IHJhd19yZXNwb25zZSwKICAgICAgICAgICAgICAgICAgICAiaXNfanNvbiI6IEZhbHNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiZXJyb3IiLAogICAgICAgICAgICAgICAgInNvdXJjZSI6ICJBUEkiLAogICAgICAgICAgICAgICAgImVycm9yIjogZiJBUEkgcmV0dXJuZWQgc3RhdHVzIGNvZGU6IHtyZXNwb25zZS5zdGF0dXNfY29kZX0iLAogICAgICAgICAgICAgICAgInJhd19yZXNwb25zZSI6IHJhd19yZXNwb25zZSBpZiByZXNwb25zZS5zdGF0dXNfY29kZSAhPSAyMDAgZWxzZSAiIgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJzdGF0dXMiOiAiZXJyb3IiLAogICAgICAgICAgICAic291cmNlIjogIkFQSSIsCiAgICAgICAgICAgICJlcnJvciI6IGYiRXJyb3IgZmV0Y2hpbmcgZGF0YToge3N0cihlKX0iCiAgICAgICAgfQoKZGVmIGZldGNoX3ZlaGljbGVfaW5mb19mcm9tX2FwaShyY19udW1iZXIpOgogICAgIiIiCiAgICBGZXRjaCB2ZWhpY2xlIGluZm8gZnJvbSBBUElzIGluIHNlcXVlbmNlIChBUEkxIHRoZW4gQVBJMikKICAgIFJldHVybnMgdmVoaWNsZSBpbmZvIG9ubHkgKG5vIGNoYWxsYW4gaW5mbykKICAgICIiIgogICAgIyBUcnkgQVBJIDEgZmlyc3QKICAgIHRyeToKICAgICAgICBhcGlfdXJsID0gVkVISUNMRV9BUElfVVJMXzEuZm9ybWF0KHJjX251bWJlcikKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChhcGlfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgIAogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGF0YS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgICMgRXh0cmFjdCB2ZWhpY2xlIGluZm8gZnJvbSBBUEkgMSByZXNwb25zZQogICAgICAgICAgICAgICAgdmVoaWNsZV9pbmZvID0gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgICAgICAgInNvdXJjZSI6ICJBUEkgMSIsCiAgICAgICAgICAgICAgICAgICAgInJlZ2lzdHJhdGlvbiI6IGRhdGEuZ2V0KCJyZWdpc3RyYXRpb24iLCByY19udW1iZXIpLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogZGF0YS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSksCiAgICAgICAgICAgICAgICAgICAgImFkZHJlc3MiOiBkYXRhLmdldCgiYWRkcmVzcyIsIHt9KSwKICAgICAgICAgICAgICAgICAgICAiY2hhbGxhbiI6IGRhdGEuZ2V0KCJjaGFsbGFuIiwge30pICAjIFdpbGwgYmUgaWdub3JlZCBpbiBkaXNwbGF5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmVoaWNsZV9pbmZvCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJBUEkgMSBmYWlsZWQ6IHtzdHIoZSl9IikKICAgIAogICAgIyBUcnkgQVBJIDIgaWYgQVBJIDEgZmFpbGVkCiAgICB0cnk6CiAgICAgICAgYXBpX3VybCA9IFZFSElDTEVfQVBJX1VSTF8yLmZvcm1hdChyY19udW1iZXIpCiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoYXBpX3VybCwgdGltZW91dD0xMCkKICAgICAgICAKICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICAjIEV4dHJhY3QgdmVoaWNsZSBpbmZvIGZyb20gQVBJIDIgcmVzcG9uc2UKICAgICAgICAgICAgICAgIHZlaGljbGVfaW5mbyA9IHsKICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogInN1Y2Nlc3MiLAogICAgICAgICAgICAgICAgICAgICJzb3VyY2UiOiAiQVBJIDIiLAogICAgICAgICAgICAgICAgICAgICJyZWdpc3RyYXRpb24iOiByY19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBkYXRhLmdldCgic3VjY2VzcyIsIEZhbHNlKSwKICAgICAgICAgICAgICAgICAgICAiYWRkcmVzcyI6IGRhdGEuZ2V0KCJ2ZWhpY2xlIiwge30pLAogICAgICAgICAgICAgICAgICAgICJjaGFsbGFuIjogeyJkYXRhIjogZGF0YS5nZXQoImNoYWxsYW5zIiwgW10pfSAgIyBXaWxsIGJlIGlnbm9yZWQgaW4gZGlzcGxheQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZlaGljbGVfaW5mbwogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiQVBJIDIgZmFpbGVkOiB7c3RyKGUpfSIpCiAgICAKICAgICMgQm90aCBBUElzIGZhaWxlZAogICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiAiRmFpbGVkIHRvIGZldGNoIHZlaGljbGUgaW5mb3JtYXRpb24gZnJvbSBhbGwgc291cmNlcyJ9CgpkZWYgZmV0Y2hfY2hhbGxhbl9pbmZvX2Zyb21fYXBpKHJjX251bWJlcik6CiAgICAiIiIKICAgIEZldGNoIGNoYWxsYW4gaW5mbyBmcm9tIEFQSXMgaW4gc2VxdWVuY2UgKEFQSTEgdGhlbiBBUEkyKQogICAgUmV0dXJucyBvbmx5IGNoYWxsYW4gaW5mb3JtYXRpb24KICAgICIiIgogICAgIyBUcnkgQVBJIDEgZmlyc3QKICAgIHRyeToKICAgICAgICBhcGlfdXJsID0gVkVISUNMRV9BUElfVVJMXzEuZm9ybWF0KHJjX251bWJlcikKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChhcGlfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgIAogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGF0YS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgIGNoYWxsYW5fZGF0YSA9IGRhdGEuZ2V0KCJjaGFsbGFuIiwge30pCiAgICAgICAgICAgICAgICBpZiBjaGFsbGFuX2RhdGEgYW5kICJkYXRhIiBpbiBjaGFsbGFuX2RhdGEgYW5kIGNoYWxsYW5fZGF0YVsiZGF0YSJdOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJzb3VyY2UiOiAiQVBJIDEiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVnaXN0cmF0aW9uIjogZGF0YS5nZXQoInJlZ2lzdHJhdGlvbiIsIHJjX251bWJlciksCiAgICAgICAgICAgICAgICAgICAgICAgICJjaGFsbGFuIjogY2hhbGxhbl9kYXRhCiAgICAgICAgICAgICAgICAgICAgfQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiQVBJIDEgZmFpbGVkOiB7c3RyKGUpfSIpCiAgICAKICAgICMgVHJ5IEFQSSAyIGlmIEFQSSAxIGZhaWxlZCBvciBoYXMgbm8gY2hhbGxhbiBkYXRhCiAgICB0cnk6CiAgICAgICAgYXBpX3VybCA9IFZFSElDTEVfQVBJX1VSTF8yLmZvcm1hdChyY19udW1iZXIpCiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoYXBpX3VybCwgdGltZW91dD0xMCkKICAgICAgICAKICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICBjaGFsbGFucyA9IGRhdGEuZ2V0KCJjaGFsbGFucyIsIFtdKQogICAgICAgICAgICAgICAgaWYgY2hhbGxhbnM6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInNvdXJjZSI6ICJBUEkgMiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWdpc3RyYXRpb24iOiByY19udW1iZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICJjaGFsbGFuIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRhdGEiOiBjaGFsbGFucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmZXRjaGVkX29uIjogZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIkFQSSAyIGZhaWxlZDoge3N0cihlKX0iKQogICAgCiAgICAjIEJvdGggQVBJcyBmYWlsZWQgb3Igbm8gY2hhbGxhbiBkYXRhCiAgICByZXR1cm4geyJzdGF0dXMiOiAibm9fZGF0YSIsICJtZXNzYWdlIjogIk5vIGNoYWxsYW4gcmVjb3JkcyBmb3VuZCBmb3IgdGhpcyB2ZWhpY2xlIn0KCmRlZiBmZXRjaF9hYWRoYWFyX2luZm9fZnJvbV9hcGkoYWFkaGFhcl9udW1iZXIpOgogICAgdHJ5OgogICAgICAgIGFwaV91cmwgPSBBQURIQUFSX0FQSV9VUkwuZm9ybWF0KGFhZGhhYXJfbnVtYmVyKQogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGFwaV91cmwsIHRpbWVvdXQ9MTApCiAgICAgICAgCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICByZXN1bHRfZGF0YSA9IGRhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgICAgICBpZiByZXN1bHRfZGF0YS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgICAgICByZXN1bHRfY29udGVudCA9IHJlc3VsdF9kYXRhLmdldCgicmVzdWx0IiwgW10pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXN1bHRfY29udGVudCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlc3VsdF9jb250ZW50LmdldCgibWVzc2FnZSIpID09ICJObyByZWNvcmRzIGZvdW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJub19kYXRhIiwgIm1lc3NhZ2UiOiAiTm8gZGF0YSBmb3VuZCBmb3IgdGhpcyBBYWRoYWFyIG51bWJlciJ9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXN1bHRfY29udGVudCwgbGlzdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlc3VsdF9jb250ZW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MiLCAiZGF0YSI6IHJlc3VsdF9jb250ZW50fQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogIm5vX2RhdGEiLCAibWVzc2FnZSI6ICJObyBkYXRhIGZvdW5kIGZvciB0aGlzIEFhZGhhYXIgbnVtYmVyIn0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAibm9fZGF0YSIsICJtZXNzYWdlIjogIk5vIGRhdGEgZm91bmQgZm9yIHRoaXMgQWFkaGFhciBudW1iZXIifQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJlcnJvciI6ICJBUEkgcmV0dXJuZWQgdW5zdWNjZXNzZnVsIHN0YXR1cyBpbiBkYXRhIn0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiB7ImVycm9yIjogIkFQSSByZXR1cm5lZCB1bnN1Y2Nlc3NmdWwgc3RhdHVzIn0KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4geyJlcnJvciI6IGYiQVBJIHJldHVybmVkIHN0YXR1cyBjb2RlOiB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9In0KICAgICAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuIHsiZXJyb3IiOiBmIkVycm9yIGZldGNoaW5nIGRhdGE6IHtzdHIoZSl9In0KCmRlZiBmb3JtYXRfYWRkcmVzcyhhZGRyZXNzX3N0cmluZyk6CiAgICBpZiBub3QgYWRkcmVzc19zdHJpbmcgb3IgYWRkcmVzc19zdHJpbmcgPT0gIk4vQSI6CiAgICAgICAgcmV0dXJuICJOL0EiCiAgICBmb3JtYXR0ZWRfYWRkcmVzcyA9IGFkZHJlc3Nfc3RyaW5nLnJlcGxhY2UoJyEhISEnLCAnLCAnKS5yZXBsYWNlKCchISEnLCAnLCAnKS5yZXBsYWNlKCchIScsICcsICcpLnJlcGxhY2UoJyEnLCAnLCAnKQogICAgcmV0dXJuIGZvcm1hdHRlZF9hZGRyZXNzCgpkZWYgc2hvd19tZW51KGNoYXRfaWQpOgogICAgbWFya3VwID0gdHlwZXMuUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSwgcm93X3dpZHRoPTIpCiAgICBudW1fYnRuID0gdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCflKIgTnVtIEluZm8iKQogICAgYWRoYXJfYnRuID0gdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfhpQgQWRoYXIgSW5mbyIpCiAgICB2ZWhpY2xlX2J0biA9IHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5qXIFZlaGljbGUgSW5mbyIpCiAgICBjaGFsbGFuX2J0biA9IHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5qTIENoYWxsYW4gSW5mbyIpCiAgICBkZXZfYnRuID0gdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfkqwgQ2hhdCB3aXRoIERldmVsb3BlciIpCiAgICAKICAgIG1hcmt1cC5hZGQobnVtX2J0biwgYWRoYXJfYnRuKQogICAgbWFya3VwLmFkZCh2ZWhpY2xlX2J0biwgY2hhbGxhbl9idG4pCiAgICBtYXJrdXAuYWRkKGRldl9idG4pICAjIFNpbmdsZSBidXR0b24gb24gdGhpcmQgcm93LCBjZW50ZXJlZAogICAgCiAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICLinIUgQ2hvb3NlIGFuIG9wdGlvbiBiZWxvdzoiLCBwYXJzZV9tb2RlPSJNYXJrZG93biIsIHJlcGx5X21hcmt1cD1tYXJrdXApCgpkZWYgc2hvd190aXBfbWVzc2FnZShjaGF0X2lkLCBmb3VuZF9hYWRoYWFyPU5vbmUpOgogICAgdGlwX21zZyA9ICLwn5KhICpQcm8gVGlwOipcblxuIgogICAgCiAgICBpZiBmb3VuZF9hYWRoYWFyOgogICAgICAgIHRpcF9tc2cgKz0gZiLwn5OEICpBYWRoYWFyIElEIEZvdW5kOiogYHtmb3VuZF9hYWRoYWFyfWBcblxuIgogICAgICAgIHRpcF9tc2cgKz0gIllvdSBjYW4gdXNlIHRoaXMgQWFkaGFhciBJRCB0bzpcbiIKICAgICAgICB0aXBfbXNnICs9ICLigKIg8J+UjSBHZXQgbW9yZSBwaG9uZSBudW1iZXJzIHJlbGF0ZWQgdG8gdGhpcyBwZXJzb24gKPCfhpQgQWRoYXIgSW5mbylcbiIKICAgICAgICB0aXBfbXNnICs9ICLigKIg8J+alyBGaW5kIHZlaGljbGUgZGV0YWlscyBpZiByZWdpc3RlcmVkICjwn5qXIFZlaGljbGUgSW5mbylcbiIKICAgICAgICB0aXBfbXNnICs9ICLigKIg8J+akyBDaGVjayBmb3IgYW55IGNoYWxsYW5zICjwn5qTIENoYWxsYW4gSW5mbylcblxuIgogICAgZWxzZToKICAgICAgICB0aXBfbXNnICs9ICJJZiB5b3UgaGF2ZSBhbiBBYWRoYWFyIElELCB5b3UgY2FuOlxuIgogICAgICAgIHRpcF9tc2cgKz0gIuKAoiDwn5SNIEZpbmQgbXVsdGlwbGUgcGhvbmUgbnVtYmVycyAo8J+GlCBBZGhhciBJbmZvKVxuIgogICAgICAgIHRpcF9tc2cgKz0gIuKAoiDwn5qXIEdldCB2ZWhpY2xlIGRldGFpbHMgKPCfmpcgVmVoaWNsZSBJbmZvKVxuIgogICAgICAgIHRpcF9tc2cgKz0gIuKAoiDwn5qTIENoZWNrIGZvciBjaGFsbGFucyAo8J+akyBDaGFsbGFuIEluZm8pXG5cbiIKICAgIAogICAgdGlwX21zZyArPSAiVHJ5IHRoZXNlIG9wdGlvbnMgZm9yIGNvbXByZWhlbnNpdmUgaW5mb3JtYXRpb24hIPCfmoAiCiAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsIHRpcF9tc2csIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKCmRlZiBjaGVja19iYW5fc3RhdHVzKHVzZXJfaWQsIGNoYXRfaWQpOgogICAgIiIiQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQgYW5kIHNlbmQgbWVzc2FnZSBpZiB0aGV5IGFyZSIiIgogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgYmFuX2luZm8gPSBnZXRfYmFubmVkX3VzZXJfaW5mbyh1c2VyX2lkKQogICAgICAgIGJhbl9tc2cgPSBmIvCfmqsgQUNDRVNTIERFTklFRFxuXG4iCiAgICAgICAgYmFuX21zZyArPSBmIllvdSBoYXZlIGJlZW4gYmFubmVkIGZyb20gdXNpbmcgdGhpcyBib3QuXG5cbiIKICAgICAgICBiYW5fbXNnICs9IGYi8J+UkiBSZWFzb246IEFjY291bnQgcmVzdHJpY3RlZCBieSBvd25lclxuIgogICAgICAgIGJhbl9tc2cgKz0gZiLwn5OFIEJhbm5lZCBhdDoge2Jhbl9pbmZvWzRdIGlmIGJhbl9pbmZvIGFuZCBsZW4oYmFuX2luZm8pID4gNCBlbHNlICdVbmtub3duJ31cblxuIgogICAgICAgIGJhbl9tc2cgKz0gZiLwn5OeIENvbnRhY3QgT3duZXI6IEB7QURNSU5fVVNFUk5BTUV9XG4iCiAgICAgICAgYmFuX21zZyArPSBmIvCfkqwgVGVsZWdyYW06IGh0dHBzOi8vdC5tZS97QURNSU5fVVNFUk5BTUV9XG5cbiIKICAgICAgICBiYW5fbXNnICs9IGYi4pqg77iPIElmIHlvdSBiZWxpZXZlIHRoaXMgaXMgYSBtaXN0YWtlLCBjb250YWN0IHRoZSBvd25lciB0byBhcHBlYWwuIgogICAgICAgIAogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgYmFuX21zZykKICAgICAgICByZXR1cm4gVHJ1ZQogICAgcmV0dXJuIEZhbHNlCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bJ3N0YXJ0JywgJ21zZycsICdiYW4nLCAndW5iYW4nLCAnYmFubmVkJ10pCmRlZiBoYW5kbGVfY29tbWFuZHMobWVzc2FnZSk6CiAgICBpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnL3N0YXJ0Jyk6CiAgICAgICAgc3RhcnQobWVzc2FnZSkKICAgIGVsaWYgbWVzc2FnZS50ZXh0LnN0YXJ0c3dpdGgoJy9tc2cnKToKICAgICAgICBicm9hZGNhc3RfbWVzc2FnZShtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnL2JhbicpOgogICAgICAgIGJhbl91c2VyX2NvbW1hbmQobWVzc2FnZSkKICAgIGVsaWYgbWVzc2FnZS50ZXh0LnN0YXJ0c3dpdGgoJy91bmJhbicpOgogICAgICAgIHVuYmFuX3VzZXJfY29tbWFuZChtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnL2Jhbm5lZCcpOgogICAgICAgIHNob3dfYmFubmVkX3VzZXJzKG1lc3NhZ2UpCgpkZWYgc3RhcnQobWVzc2FnZSk6CiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYmFubmVkIGJlZm9yZSBhbGxvd2luZyBzdGFydAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgc2F2ZV91c2VyKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmZyb21fdXNlci51c2VybmFtZSwgCiAgICAgICAgICAgICAgbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZSwgbWVzc2FnZS5mcm9tX3VzZXIubGFzdF9uYW1lKQogICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi8J+RiyBJIGNhbiBmaW5kIE51bWJlciBJbmZvLCBBYWRoYWFyIEluZm8sIFZlaGljbGUgSW5mbywgYW5kIENoYWxsYW4gSW5mby4gSnVzdCBjaG9vc2UgYW4gb3B0aW9uIGJlbG93ISIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dCBpbiBbIvCflKIgTnVtIEluZm8iLCAi8J+GlCBBZGhhciBJbmZvIiwgIvCfmpcgVmVoaWNsZSBJbmZvIiwgIvCfmpMgQ2hhbGxhbiBJbmZvIiwgIvCfkqwgQ2hhdCB3aXRoIERldmVsb3BlciJdKQpkZWYgaGFuZGxlX21lbnVfYnV0dG9ucyhtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQgYmVmb3JlIHByb2Nlc3NpbmcgYW55IG1lbnUgYnV0dG9uCiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBpZiBtZXNzYWdlLnRleHQgPT0gIvCflKIgTnVtIEluZm8iOgogICAgICAgIGFza19udW1iZXIobWVzc2FnZSkKICAgIGVsaWYgbWVzc2FnZS50ZXh0ID09ICLwn4aUIEFkaGFyIEluZm8iOgogICAgICAgIGFza19hYWRoYWFyX251bWJlcihtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQgPT0gIvCfmpcgVmVoaWNsZSBJbmZvIjoKICAgICAgICBhc2tfdmVoaWNsZV9yYyhtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQgPT0gIvCfmpMgQ2hhbGxhbiBJbmZvIjoKICAgICAgICBhc2tfY2hhbGxhbl9yYyhtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQgPT0gIvCfkqwgQ2hhdCB3aXRoIERldmVsb3BlciI6CiAgICAgICAgY2hhdF93aXRoX2RldihtZXNzYWdlKQoKZGVmIGFza19udW1iZXIobWVzc2FnZSk6CiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYmFubmVkCiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIvCfk7EgUGxlYXNlIGVudGVyIGEgKjEwLWRpZ2l0KiBtb2JpbGUgbnVtYmVyOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgIGJvdC5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIHByb2Nlc3NfbnVtYmVyX2lucHV0KQoKZGVmIHByb2Nlc3NfbnVtYmVyX2lucHV0KG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgbWVzc2FnZS50ZXh0LnN0YXJ0c3dpdGgoJy8nKSBvciBtZXNzYWdlLnRleHQgaW4gWyLwn5SiIE51bSBJbmZvIiwgIvCfhpQgQWRoYXIgSW5mbyIsICLwn5qXIFZlaGljbGUgSW5mbyIsICLwn5qTIENoYWxsYW4gSW5mbyIsICLwn5KsIENoYXQgd2l0aCBEZXZlbG9wZXIiXToKICAgICAgICBib3QucHJvY2Vzc19uZXdfbWVzc2FnZXMoW21lc3NhZ2VdKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgaWYgbm90IChtZXNzYWdlLnRleHQuaXNkaWdpdCgpIGFuZCBsZW4obWVzc2FnZS50ZXh0KSA9PSAxMCk6CiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgSW52YWxpZCBudW1iZXIhIFBsZWFzZSBlbnRlciBhICoxMC1kaWdpdCogbW9iaWxlIG51bWJlcjoiLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19udW1iZXJfaW5wdXQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIHNhdmVfdXNlcihtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5mcm9tX3VzZXIudXNlcm5hbWUsIAogICAgICAgICAgICAgIG1lc3NhZ2UuZnJvbV91c2VyLmZpcnN0X25hbWUsIG1lc3NhZ2UuZnJvbV91c2VyLmxhc3RfbmFtZSkKICAgIAogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5SOIEZldGNoaW5nIGRldGFpbHMuLi4gUGxlYXNlIHdhaXQg4o+zIikKICAgIAogICAgZGF0YSA9IGZldGNoX251bWJlcl9pbmZvX2Zyb21fYXBpKG1lc3NhZ2UudGV4dCkKICAgIAogICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpID09ICJlcnJvciI6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIEVycm9yIGZyb20ge2RhdGEuZ2V0KCdzb3VyY2UnLCAnQVBJJyl9OiB7ZGF0YS5nZXQoJ2Vycm9yJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSAhPSAic3VjY2VzcyI6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgRmFpbGVkIHRvIGZldGNoIGRhdGEgZnJvbSBBUEkuIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICAjIERpc3BsYXkgcmF3IEFQSSByZXNwb25zZSBmaXJzdAogICAgaWYgZGF0YS5nZXQoInJhd19yZXNwb25zZSIpOgogICAgICAgIHJhd19yZXNwb25zZV9tc2cgPSBmIvCfk6EgKkFQSSBSYXcgUmVzcG9uc2UqXG5cbiIKICAgICAgICByYXdfcmVzcG9uc2VfbXNnICs9IGYiYGBgXG57ZGF0YVsncmF3X3Jlc3BvbnNlJ11bOjM1MDBdfVxuYGBgIgogICAgICAgIGlmIGxlbihkYXRhWydyYXdfcmVzcG9uc2UnXSkgPiAzNTAwOgogICAgICAgICAgICByYXdfcmVzcG9uc2VfbXNnICs9IGYiXG5cbvCfk50gKlJlc3BvbnNlIHRydW5jYXRlZCwgZnVsbCBsZW5ndGg6IHtsZW4oZGF0YVsncmF3X3Jlc3BvbnNlJ10pfSBjaGFyYWN0ZXJzKiIKICAgICAgICAKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgcmF3X3Jlc3BvbnNlX21zZywgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgCiAgICAjIFRyeSB0byBwYXJzZSBhbmQgZGlzcGxheSBzdHJ1Y3R1cmVkIGRhdGEgaWYgYXZhaWxhYmxlCiAgICBpZiBkYXRhLmdldCgiaXNfanNvbiIpIGFuZCBkYXRhLmdldCgicGFyc2VkX2RhdGEiKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHBhcnNlZF9kYXRhID0gZGF0YVsicGFyc2VkX2RhdGEiXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBEaXNwbGF5IGJhc2ljIGluZm8gYWJvdXQgdGhlIHJlc3BvbnNlCiAgICAgICAgICAgIGluZm9fbXNnID0gZiLwn5OKICpBUEkgUmVzcG9uc2UgSW5mbypcblxuIgogICAgICAgICAgICBpbmZvX21zZyArPSBmIuKchSAqU3RhdHVzKjogU3VjY2Vzc1xuIgogICAgICAgICAgICBpbmZvX21zZyArPSBmIvCflJcgKlNvdXJjZSo6IHtkYXRhLmdldCgnc291cmNlJywgJ0FQSScpfVxuIgogICAgICAgICAgICBpbmZvX21zZyArPSBmIvCfk4QgKkZvcm1hdCo6IEpTT05cbiIKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocGFyc2VkX2RhdGEsIGRpY3QpOgogICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OLICpSZXNwb25zZSBUeXBlKjogRGljdGlvbmFyeVxuIgogICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5SRICpLZXlzKjogeycsICcuam9pbihwYXJzZWRfZGF0YS5rZXlzKCkpfVxuIgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENoZWNrIGZvciBjb21tb24gc3RydWN0dXJlcwogICAgICAgICAgICAgICAgaWYgcGFyc2VkX2RhdGEuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLinIUgKkFQSSBTdWNjZXNzKjoge3BhcnNlZF9kYXRhLmdldCgnc3VjY2VzcycpfVxuIgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAiZGF0YSIgaW4gcGFyc2VkX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OmICpIYXMgRGF0YSBGaWVsZCo6IFllc1xuIgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRhdGFfZmllbGQgPSBwYXJzZWRfZGF0YVsiZGF0YSJdCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkYXRhX2ZpZWxkLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OBICpEYXRhIFR5cGUqOiBEaWN0aW9uYXJ5XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRhdGFfZmllbGQuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmZvX21zZyArPSBmIuKchSAqRGF0YSBTdWNjZXNzKjoge2RhdGFfZmllbGQuZ2V0KCdzdWNjZXNzJyl9XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAicmVzdWx0IiBpbiBkYXRhX2ZpZWxkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZGF0YV9maWVsZFsicmVzdWx0Il0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmVzdWx0LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmZvX21zZyArPSBmIvCfk4ogKlJlc3VsdHMqOiB7bGVuKHJlc3VsdCl9IGl0ZW1zXG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmZvX21zZyArPSBmIvCfk4ogKlJlc3VsdHMqOiBEaWN0aW9uYXJ5IHdpdGgge2xlbihyZXN1bHQua2V5cygpKX0ga2V5c1xuIgogICAgICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShkYXRhX2ZpZWxkLCBsaXN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OKICpEYXRhIEl0ZW1zKjoge2xlbihkYXRhX2ZpZWxkKX0gaXRlbXNcbiIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxpZiAicmVzdWx0IiBpbiBwYXJzZWRfZGF0YToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBwYXJzZWRfZGF0YVsicmVzdWx0Il0KICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdCwgbGlzdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGluZm9fbXNnICs9IGYi8J+TiiAqUmVzdWx0cyo6IHtsZW4ocmVzdWx0KX0gaXRlbXNcbiIKICAgICAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OKICpSZXN1bHRzKjogRGljdGlvbmFyeSB3aXRoIHtsZW4ocmVzdWx0LmtleXMoKSl9IGtleXNcbiIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocGFyc2VkX2RhdGEsIGxpc3QpOgogICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OLICpSZXNwb25zZSBUeXBlKjogTGlzdFxuIgogICAgICAgICAgICAgICAgaW5mb19tc2cgKz0gZiLwn5OKICpJdGVtcyo6IHtsZW4ocGFyc2VkX2RhdGEpfSBpdGVtc1xuIgogICAgICAgICAgICAKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGluZm9fbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRyeSB0byBleHRyYWN0IGFuZCBkaXNwbGF5IHVzZXIgZGF0YSBpZiBpdCBleGlzdHMgaW4gdGhlIHN0cnVjdHVyZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHBhcnNlZF9kYXRhLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAjIFRyeSBkaWZmZXJlbnQgcG9zc2libGUgZGF0YSBwYXRocwogICAgICAgICAgICAgICAgICAgIGlmICJkYXRhIiBpbiBwYXJzZWRfZGF0YSBhbmQgaXNpbnN0YW5jZShwYXJzZWRfZGF0YVsiZGF0YSJdLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgImRhdGEiIGluIHBhcnNlZF9kYXRhWyJkYXRhIl0gYW5kIGlzaW5zdGFuY2UocGFyc2VkX2RhdGFbImRhdGEiXVsiZGF0YSJdLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICJyZXN1bHQiIGluIHBhcnNlZF9kYXRhWyJkYXRhIl1bImRhdGEiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBwYXJzZWRfZGF0YVsiZGF0YSJdWyJkYXRhIl1bInJlc3VsdCJdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXN1bHQsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiAicmVzdWx0IiBpbiBwYXJzZWRfZGF0YVsiZGF0YSJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcGFyc2VkX2RhdGFbImRhdGEiXVsicmVzdWx0Il0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmVzdWx0LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSByZXN1bHQKICAgICAgICAgICAgICAgICAgICBlbGlmICJyZXN1bHQiIGluIHBhcnNlZF9kYXRhOgogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBwYXJzZWRfZGF0YVsicmVzdWx0Il0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXN1bHQsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9kYXRhID0gcmVzdWx0CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJfZGF0YToKICAgICAgICAgICAgICAgICAgICAjIERpc3BsYXkgdXNlciBpbmZvcm1hdGlvbgogICAgICAgICAgICAgICAgICAgIGZvdW5kX2FhZGhhYXJzID0gc2V0KCkKICAgICAgICAgICAgICAgICAgICBmb3IgaSwgcCBpbiBlbnVtZXJhdGUodXNlcl9kYXRhLCAxKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIvCfk7IgKlVzZXIgSW5mb3JtYXRpb24qIChQYXJzZWQgZnJvbSBBUEkpXG5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIvCfk54gKk1vYmlsZSBObyogICAgIDogYHtwLmdldCgnbW9iaWxlJywnTi9BJyl9YFxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYi8J+RqCAqTmFtZSogICAgICAgICAgOiBge3AuZ2V0KCduYW1lJywnTi9BJyl9YFxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYi8J+RtCAqRmF0aGVyIE5hbWUqICAgOiBge3AuZ2V0KCdmYXRoZXJfbmFtZScsJ04vQScpfWBcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIvCfj6AgKkFkZHJlc3MqICAgICAgIDogYHtmb3JtYXRfYWRkcmVzcyhwLmdldCgnYWRkcmVzcycsJ04vQScpKX1gXG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiLwn5aEICpBYWRoYXIgSUQqICAgICA6IGB7cC5nZXQoJ2lkX251bWJlcicsJ04vQScpfWBcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIvCfk7EgKkFsdCBNb2JpbGUqICAgIDogYHtwLmdldCgnYWx0X21vYmlsZScsJ04vQScpfWBcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIvCfk40gKkNpcmNsZSogICAgICAgIDogYHtwLmdldCgnY2lyY2xlJywnTi9BJyl9YFxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYi8J+TpyAqRW1haWwqICAgICAgICAgOiBge3AuZ2V0KCdlbWFpbCcsJ04vQScpfWBcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHAuZ2V0KCdpZF9udW1iZXInKSBhbmQgcC5nZXQoJ2lkX251bWJlcicpICE9ICdOL0EnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2FhZGhhYXJzLmFkZChwLmdldCgnaWRfbnVtYmVyJykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgZm91bmRfYWFkaGFhcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3dfdGlwX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBsaXN0KGZvdW5kX2FhZGhhYXJzKVswXSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgcGFyc2VfZXJyb3I6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIuKaoO+4jyAqRGF0YSBQYXJzaW5nIE5vdGUqXG5cbiIKICAgICAgICAgICAgICAgIGVycm9yX21zZyArPSBmIkNvdWxkIG5vdCBwYXJzZSB1c2VyIGRhdGEgZnJvbSByZXNwb25zZSBzdHJ1Y3R1cmUuXG4iCiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgKz0gZiJBUEkgcmVzcG9uc2UgZm9ybWF0IG1heSBoYXZlIGNoYW5nZWQuXG5cbiIKICAgICAgICAgICAgICAgIGVycm9yX21zZyArPSBmIipSYXcgSlNPTiBzdHJ1Y3R1cmUgc2hvd24gYWJvdmUgZm9yIGRlYnVnZ2luZy4qIgogICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGVycm9yX21zZywgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiLimqDvuI8gKkpTT04gUHJvY2Vzc2luZyBFcnJvcipcblxuIgogICAgICAgICAgICBlcnJvcl9tc2cgKz0gZiJFcnJvciBwcm9jZXNzaW5nIEpTT04gcmVzcG9uc2U6IHtzdHIoZSl9IgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZXJyb3JfbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAKICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCgpkZWYgYXNrX2FhZGhhYXJfbnVtYmVyKG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn4aUIFBsZWFzZSBlbnRlciBhICoxMi1kaWdpdCogQWFkaGFhciBudW1iZXI6IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19hYWRoYWFyX2luZm9faW5wdXQpCgpkZWYgcHJvY2Vzc19hYWRoYWFyX2luZm9faW5wdXQobWVzc2FnZSk6CiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYmFubmVkCiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnLycpIG9yIG1lc3NhZ2UudGV4dCBpbiBbIvCflKIgTnVtIEluZm8iLCAi8J+GlCBBZGhhciBJbmZvIiwgIvCfmpcgVmVoaWNsZSBJbmZvIiwgIvCfmpMgQ2hhbGxhbiBJbmZvIiwgIvCfkqwgQ2hhdCB3aXRoIERldmVsb3BlciJdOgogICAgICAgIGJvdC5wcm9jZXNzX25ld19tZXNzYWdlcyhbbWVzc2FnZV0pCiAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICBpZiBub3QgKG1lc3NhZ2UudGV4dC5pc2RpZ2l0KCkgYW5kIGxlbihtZXNzYWdlLnRleHQpID09IDEyKToKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBJbnZhbGlkIEFhZGhhYXIgbnVtYmVyISBQbGVhc2UgZW50ZXIgYSAqMTItZGlnaXQqIEFhZGhhYXIgbnVtYmVyOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgICAgICBib3QucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBwcm9jZXNzX2FhZGhhYXJfaW5mb19pbnB1dCkKICAgICAgICByZXR1cm4KICAgIAogICAgc2F2ZV91c2VyKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmZyb21fdXNlci51c2VybmFtZSwgCiAgICAgICAgICAgICAgbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZSwgbWVzc2FnZS5mcm9tX3VzZXIubGFzdF9uYW1lKQogICAgCiAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIvCflI4gRmV0Y2hpbmcgQWFkaGFhciBkZXRhaWxzLi4uIFBsZWFzZSB3YWl0IOKPsyIpCiAgICAKICAgIGRhdGEgPSBmZXRjaF9hYWRoYWFyX2luZm9fZnJvbV9hcGkobWVzc2FnZS50ZXh0KQogICAgCiAgICBpZiAiZXJyb3IiIGluIGRhdGE6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIEVycm9yOiB7ZGF0YVsnZXJyb3InXX0iLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpID09ICJub19kYXRhIjoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiLinYwge2RhdGEuZ2V0KCdtZXNzYWdlJywgJ05vIGRhdGEgZm91bmQgZm9yIHRoaXMgQWFkaGFhciBudW1iZXIuJyl9IikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgIT0gInN1Y2Nlc3MiOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIE5vIGRhdGEgZm91bmQgZm9yIHRoaXMgQWFkaGFhciBudW1iZXIuIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICByZXN1bHRzID0gZGF0YS5nZXQoImRhdGEiLCBbXSkKICAgIAogICAgaWYgbm90IHJlc3VsdHM6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgTm8gZGF0YSBmb3VuZCBmb3IgdGhpcyBBYWRoYWFyIG51bWJlci4iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICB1bmlxdWVfcmVzdWx0cyA9IFtdCiAgICBzZWVuX21vYmlsZXMgPSBzZXQoKQogICAgCiAgICAjIEZpbHRlciBkdXBsaWNhdGUgbW9iaWxlIG51bWJlcnMKICAgIGZvciBwIGluIHJlc3VsdHM6CiAgICAgICAgbW9iaWxlID0gcC5nZXQoJ21vYmlsZScsICcnKQogICAgICAgIGlmIG1vYmlsZSBhbmQgbW9iaWxlIG5vdCBpbiBzZWVuX21vYmlsZXM6CiAgICAgICAgICAgIHNlZW5fbW9iaWxlcy5hZGQobW9iaWxlKQogICAgICAgICAgICB1bmlxdWVfcmVzdWx0cy5hcHBlbmQocCkKICAgIAogICAgaWYgbm90IHVuaXF1ZV9yZXN1bHRzOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIE5vIGRhdGEgZm91bmQgZm9yIHRoaXMgQWFkaGFhciBudW1iZXIuIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgbXNnID0gZiLwn5OEICpBYWRoYWFyIEluZm9ybWF0aW9uKlxuIgogICAgbXNnICs9IGYi8J+GlCAqQWFkaGFhciBObyogICAgOiBge21lc3NhZ2UudGV4dH1gXG4iCiAgICBtc2cgKz0gZiLwn5GoICpOYW1lKiAgICAgICAgICA6IGB7dW5pcXVlX3Jlc3VsdHNbMF0uZ2V0KCduYW1lJywnTi9BJyl9YFxuIgogICAgbXNnICs9IGYi8J+RtCAqRmF0aGVyIE5hbWUqICAgOiBge3VuaXF1ZV9yZXN1bHRzWzBdLmdldCgnZmF0aGVyX25hbWUnLCdOL0EnKX1gXG4iCiAgICBtc2cgKz0gZiLwn4+gICpBZGRyZXNzKiAgICAgICA6IGB7Zm9ybWF0X2FkZHJlc3ModW5pcXVlX3Jlc3VsdHNbMF0uZ2V0KCdhZGRyZXNzJywnTi9BJykpfWBcblxuIgogICAgCiAgICBtc2cgKz0gIvCfk7EgKkFzc29jaWF0ZWQgTW9iaWxlIE51bWJlcnMqXG5cbiIKICAgIAogICAgZm9yIGksIHAgaW4gZW51bWVyYXRlKHVuaXF1ZV9yZXN1bHRzLCAxKToKICAgICAgICBtc2cgKz0gZiIqTnVtYmVyIHtpfToqXG4iCiAgICAgICAgbXNnICs9IGYi8J+TniAqTW9iaWxlIE5vKiAgICAgOiBge3AuZ2V0KCdtb2JpbGUnLCdOL0EnKX1gXG4iCiAgICAgICAgaWYgcC5nZXQoJ2FsdF9tb2JpbGUnKSBhbmQgcC5nZXQoJ2FsdF9tb2JpbGUnKSAhPSAnTi9BJzoKICAgICAgICAgICAgbXNnICs9IGYi8J+TsSAqQWx0IE1vYmlsZSogICAgOiBge3AuZ2V0KCdhbHRfbW9iaWxlJywnTi9BJyl9YFxuIgogICAgICAgIG1zZyArPSBmIvCfk40gKkNpcmNsZSogICAgICAgIDogYHtwLmdldCgnY2lyY2xlJywnTi9BJyl9YFxuIgogICAgICAgIGlmIHAuZ2V0KCdlbWFpbCcpIGFuZCBwLmdldCgnZW1haWwnKSAhPSAnTi9BJzoKICAgICAgICAgICAgbXNnICs9IGYi8J+TpyAqRW1haWwqICAgICAgICAgOiBge3AuZ2V0KCdlbWFpbCcsJ04vQScpfWBcbiIKICAgICAgICBtc2cgKz0gIuKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxuIgogICAgCiAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQoKZGVmIGFza192ZWhpY2xlX3JjKG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5qXIFBsZWFzZSBlbnRlciAqVmVoaWNsZSBSZWdpc3RyYXRpb24gTnVtYmVyKiAoZS5nLiwgYEhSMjZDRTc2NzRgKToiLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICBib3QucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBwcm9jZXNzX3ZlaGljbGVfaW5wdXQpCgpkZWYgcHJvY2Vzc192ZWhpY2xlX2lucHV0KG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgbWVzc2FnZS50ZXh0LnN0YXJ0c3dpdGgoJy8nKSBvciBtZXNzYWdlLnRleHQgaW4gWyLwn5SiIE51bSBJbmZvIiwgIvCfhpQgQWRoYXIgSW5mbyIsICLwn5qXIFZlaGljbGUgSW5mbyIsICLwn5qTIENoYWxsYW4gSW5mbyIsICLwn5KsIENoYXQgd2l0aCBEZXZlbG9wZXIiXToKICAgICAgICBib3QucHJvY2Vzc19uZXdfbWVzc2FnZXMoW21lc3NhZ2VdKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgcmNfbnVtYmVyID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkudXBwZXIoKQogICAgCiAgICBpZiBub3QgcmNfbnVtYmVyOgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIEludmFsaWQgUkMgbnVtYmVyISBQbGVhc2UgZW50ZXIgYSB2YWxpZCB2ZWhpY2xlIHJlZ2lzdHJhdGlvbiBudW1iZXI6IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIGJvdC5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIHByb2Nlc3NfdmVoaWNsZV9pbnB1dCkKICAgICAgICByZXR1cm4KICAgIAogICAgc2F2ZV91c2VyKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmZyb21fdXNlci51c2VybmFtZSwgCiAgICAgICAgICAgICAgbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZSwgbWVzc2FnZS5mcm9tX3VzZXIubGFzdF9uYW1lKQogICAgCiAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIvCfmpcgRmV0Y2hpbmcgdmVoaWNsZSBkZXRhaWxzLi4uIFBsZWFzZSB3YWl0IOKPsyIpCiAgICAKICAgIGRhdGEgPSBmZXRjaF92ZWhpY2xlX2luZm9fZnJvbV9hcGkocmNfbnVtYmVyKQogICAgCiAgICBpZiAiZXJyb3IiIGluIGRhdGE6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIEVycm9yOiB7ZGF0YVsnZXJyb3InXX0iLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpID09ICJlcnJvciI6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIHtkYXRhLmdldCgnbWVzc2FnZScsICdGYWlsZWQgdG8gZmV0Y2ggdmVoaWNsZSBpbmZvcm1hdGlvbi4nKX0iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSAhPSAic3VjY2VzcyI6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgTm8gdmVoaWNsZSBkZXRhaWxzIGZvdW5kIGZvciB0aGlzIFJDIG51bWJlci4iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICBhZGRyZXNzX2RhdGEgPSBkYXRhLmdldCgiYWRkcmVzcyIsIHt9KQogICAgc291cmNlID0gZGF0YS5nZXQoInNvdXJjZSIsICJBUEkiKQogICAgCiAgICBtc2cgPSBmIvCfmpcgKlZlaGljbGUgSW5mb3JtYXRpb24qIChTb3VyY2U6IHtzb3VyY2V9KVxuXG4iCiAgICAKICAgICMgQmFzaWMgSW5mb3JtYXRpb24KICAgIG1zZyArPSAi8J+TiyAqQmFzaWMgSW5mb3JtYXRpb24qXG4iCiAgICBtc2cgKz0gZiLwn5SiICpSZWdpc3RyYXRpb24qICAgOiBge2RhdGEuZ2V0KCdyZWdpc3RyYXRpb24nLCByY19udW1iZXIpfWBcbiIKICAgIG1zZyArPSBmIuKchSAqU3RhdHVzKiAgICAgICAgIDogYHtkYXRhLmdldCgnc3VjY2VzcycsICdOL0EnKX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoIm93bmVyX25hbWUiKToKICAgICAgICBtc2cgKz0gZiLwn5GkICpPd25lciBOYW1lKiAgICAgOiBge2FkZHJlc3NfZGF0YVsnb3duZXJfbmFtZSddfWBcbiIKICAgIAogICAgaWYgYWRkcmVzc19kYXRhLmdldCgibWFrZV9uYW1lMiIpIG9yIGFkZHJlc3NfZGF0YS5nZXQoIm1ha2VfbmFtZSIpOgogICAgICAgIG1ha2UgPSBhZGRyZXNzX2RhdGEuZ2V0KCJtYWtlX25hbWUyIikgb3IgYWRkcmVzc19kYXRhLmdldCgibWFrZV9uYW1lIikgb3IgIk4vQSIKICAgICAgICBtc2cgKz0gZiLwn4+tICpNYWtlKiAgICAgICAgICAgOiBge21ha2V9YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJtb2RlbF9uYW1lMiIpIG9yIGFkZHJlc3NfZGF0YS5nZXQoIm1vZGVsX25hbWUiKToKICAgICAgICBtb2RlbCA9IGFkZHJlc3NfZGF0YS5nZXQoIm1vZGVsX25hbWUyIikgb3IgYWRkcmVzc19kYXRhLmdldCgibW9kZWxfbmFtZSIpIG9yICJOL0EiCiAgICAgICAgbXNnICs9IGYi8J+amSAqTW9kZWwqICAgICAgICAgIDogYHttb2RlbH1gXG4iCiAgICAKICAgIG1zZyArPSAiXG4iCiAgICAKICAgICMgVmVoaWNsZSBEZXRhaWxzCiAgICBtc2cgKz0gIvCflKcgKlZlaGljbGUgRGV0YWlscypcbiIKICAgIAogICAgaWYgYWRkcmVzc19kYXRhLmdldCgidmVoaWNsZV90eXBlX3Byb2Nlc3NlZCIpOgogICAgICAgIG1zZyArPSBmIvCfj7fvuI8gKlZlaGljbGUgVHlwZSogICA6IGB7YWRkcmVzc19kYXRhWyd2ZWhpY2xlX3R5cGVfcHJvY2Vzc2VkJ119YFxuIgogICAgZWxpZiBhZGRyZXNzX2RhdGEuZ2V0KCJ2ZWhpY2xlX3R5cGUiKToKICAgICAgICBtc2cgKz0gZiLwn4+377iPICpWZWhpY2xlIFR5cGUqICAgOiBge2FkZHJlc3NfZGF0YVsndmVoaWNsZV90eXBlJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJmdWVsX3R5cGUiKToKICAgICAgICBtc2cgKz0gZiLim70gKkZ1ZWwgVHlwZSogICAgICA6IGB7YWRkcmVzc19kYXRhWydmdWVsX3R5cGUnXX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInJlZ2lzdHJhdGlvbl95ZWFyIikgYW5kIGFkZHJlc3NfZGF0YS5nZXQoInJlZ2lzdHJhdGlvbl9tb250aCIpOgogICAgICAgIG1zZyArPSBmIvCfk4UgKlJlZ2lzdHJhdGlvbiogICA6IGB7YWRkcmVzc19kYXRhWydyZWdpc3RyYXRpb25feWVhciddfS17YWRkcmVzc19kYXRhWydyZWdpc3RyYXRpb25fbW9udGgnXX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInJlZ2lzdHJhdGlvbl9kYXRlIik6CiAgICAgICAgbXNnICs9IGYi8J+ThiAqUmVnIERhdGUqICAgICAgIDogYHthZGRyZXNzX2RhdGFbJ3JlZ2lzdHJhdGlvbl9kYXRlJ119YFxuIgogICAgCiAgICBtc2cgKz0gIlxuIgogICAgCiAgICAjIEFkZHJlc3MgSW5mb3JtYXRpb24KICAgIG1zZyArPSAi8J+TjSAqQWRkcmVzcyBJbmZvcm1hdGlvbipcbiIKICAgIAogICAgaWYgYWRkcmVzc19kYXRhLmdldCgicGVybWFuZW50X2FkZHJlc3MiKToKICAgICAgICBtc2cgKz0gZiLwn4+gICpQZXJtYW5lbnQgQWRkciogOiBge2FkZHJlc3NfZGF0YVsncGVybWFuZW50X2FkZHJlc3MnXX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInByZXNlbnRfYWRkcmVzcyIpOgogICAgICAgIG1zZyArPSBmIvCfk40gKlByZXNlbnQgQWRkciogICA6IGB7YWRkcmVzc19kYXRhWydwcmVzZW50X2FkZHJlc3MnXX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInJlZ2lzdHJhdGlvbl9hZGRyZXNzIik6CiAgICAgICAgbXNnICs9IGYi8J+PoiAqUmVnIEFkZHJlc3MqICAgIDogYHthZGRyZXNzX2RhdGFbJ3JlZ2lzdHJhdGlvbl9hZGRyZXNzJ119YFxuIgogICAgCiAgICBtc2cgKz0gIlxuIgogICAgCiAgICAjIFRlY2huaWNhbCBEZXRhaWxzCiAgICBtc2cgKz0gIuKame+4jyAqVGVjaG5pY2FsIERldGFpbHMqXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoImNoYXNzaXNfbnVtYmVyIik6CiAgICAgICAgbXNnICs9IGYi8J+UqSAqQ2hhc3NpcyBObyogICAgIDogYHthZGRyZXNzX2RhdGFbJ2NoYXNzaXNfbnVtYmVyJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJlbmdpbmVfbnVtYmVyIik6CiAgICAgICAgbXNnICs9IGYi8J+UpyAqRW5naW5lIE5vKiAgICAgIDogYHthZGRyZXNzX2RhdGFbJ2VuZ2luZV9udW1iZXInXX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoImlzX2NvbW1lcmNpYWwiKSBpcyBub3QgTm9uZToKICAgICAgICBjb21tZXJjaWFsID0gIlllcyIgaWYgYWRkcmVzc19kYXRhWyJpc19jb21tZXJjaWFsIl0gZWxzZSAiTm8iCiAgICAgICAgbXNnICs9IGYi8J+PoiAqQ29tbWVyY2lhbCogICAgIDogYHtjb21tZXJjaWFsfWBcbiIKICAgIAogICAgIyBJbnN1cmFuY2UgSW5mbwogICAgaWYgYWRkcmVzc19kYXRhLmdldCgicHJldmlvdXNfaW5zdXJlciIpOgogICAgICAgIG1zZyArPSAiXG7wn5uh77iPICpJbnN1cmFuY2UgSW5mbypcbiIKICAgICAgICBtc2cgKz0gZiLwn4+iICpJbnN1cmVyKiAgICAgICAgOiBge2FkZHJlc3NfZGF0YVsncHJldmlvdXNfaW5zdXJlciddfWBcbiIKICAgICAgICAKICAgICAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJwcmV2aW91c19wb2xpY3lfZXhwaXJ5X2RhdGUiKToKICAgICAgICAgICAgc3RhdHVzID0gIuKchSBBY3RpdmUiIGlmIG5vdCBhZGRyZXNzX2RhdGEuZ2V0KCJwcmV2aW91c19wb2xpY3lfZXhwaXJlZCIsIFRydWUpIGVsc2UgIuKdjCBFeHBpcmVkIgogICAgICAgICAgICBtc2cgKz0gZiLwn5OFICpFeHBpcnkgRGF0ZSogICAgOiBge2FkZHJlc3NfZGF0YVsncHJldmlvdXNfcG9saWN5X2V4cGlyeV9kYXRlJ119YFxuIgogICAgICAgICAgICBtc2cgKz0gZiLwn5OKICpTdGF0dXMqICAgICAgICAgOiBge3N0YXR1c31gXG4iCiAgICAKICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBtc2csIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCgpkZWYgYXNrX2NoYWxsYW5fcmMobWVzc2FnZSk6CiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYmFubmVkCiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIvCfmpMgUGxlYXNlIGVudGVyICpWZWhpY2xlIFJlZ2lzdHJhdGlvbiBOdW1iZXIqIGZvciBjaGFsbGFuIGluZm8gKGUuZy4sIGBIUjI2Q0U3Njc0YCk6IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19jaGFsbGFuX2lucHV0KQoKZGVmIHByb2Nlc3NfY2hhbGxhbl9pbnB1dChtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQKICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIG1lc3NhZ2UudGV4dC5zdGFydHN3aXRoKCcvJykgb3IgbWVzc2FnZS50ZXh0IGluIFsi8J+UoiBOdW0gSW5mbyIsICLwn4aUIEFkaGFyIEluZm8iLCAi8J+alyBWZWhpY2xlIEluZm8iLCAi8J+akyBDaGFsbGFuIEluZm8iLCAi8J+SrCBDaGF0IHdpdGggRGV2ZWxvcGVyIl06CiAgICAgICAgYm90LnByb2Nlc3NfbmV3X21lc3NhZ2VzKFttZXNzYWdlXSkKICAgICAgICByZXR1cm4KICAgICAgICAKICAgIHJjX251bWJlciA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnVwcGVyKCkKICAgIAogICAgaWYgbm90IHJjX251bWJlcjoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBJbnZhbGlkIFJDIG51bWJlciEgUGxlYXNlIGVudGVyIGEgdmFsaWQgdmVoaWNsZSByZWdpc3RyYXRpb24gbnVtYmVyOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgICAgICBib3QucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBwcm9jZXNzX2NoYWxsYW5faW5wdXQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIHNhdmVfdXNlcihtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5mcm9tX3VzZXIudXNlcm5hbWUsIAogICAgICAgICAgICAgIG1lc3NhZ2UuZnJvbV91c2VyLmZpcnN0X25hbWUsIG1lc3NhZ2UuZnJvbV91c2VyLmxhc3RfbmFtZSkKICAgIAogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5qTIEZldGNoaW5nIGNoYWxsYW4gaW5mb3JtYXRpb24uLi4gUGxlYXNlIHdhaXQg4o+zIikKICAgIAogICAgZGF0YSA9IGZldGNoX2NoYWxsYW5faW5mb19mcm9tX2FwaShyY19udW1iZXIpCiAgICAKICAgIGlmICJlcnJvciIgaW4gZGF0YToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiLinYwgRXJyb3I6IHtkYXRhWydlcnJvciddfSIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgPT0gIm5vX2RhdGEiOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKchSBObyBjaGFsbGFuIHJlY29yZHMgZm91bmQgZm9yIHZlaGljbGU6IGB7cmNfbnVtYmVyfWAiKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSAhPSAic3VjY2VzcyI6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgTm8gY2hhbGxhbiBpbmZvcm1hdGlvbiBmb3VuZCBmb3IgdGhpcyBSQyBudW1iZXIuIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgY2hhbGxhbl9kYXRhID0gZGF0YS5nZXQoImNoYWxsYW4iLCB7fSkKICAgIGNoYWxsYW5fbGlzdCA9IGNoYWxsYW5fZGF0YS5nZXQoImRhdGEiLCBbXSkKICAgIHNvdXJjZSA9IGRhdGEuZ2V0KCJzb3VyY2UiLCAiQVBJIikKICAgIAogICAgaWYgbm90IGNoYWxsYW5fbGlzdDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiLinIUgTm8gY2hhbGxhbiByZWNvcmRzIGZvdW5kIGZvciB2ZWhpY2xlOiBge3JjX251bWJlcn1gIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICAjIEZpcnN0LCBzZW5kIHN1bW1hcnkKICAgIHRvdGFsX2NoYWxsYW5zID0gbGVuKGNoYWxsYW5fbGlzdCkKICAgIHRvdGFsX2Ftb3VudCA9IHN1bShmbG9hdChjaGFsbGFuLmdldCgiYW1vdW50Iiwge30pLmdldCgidG90YWwiLCAwKSkgZm9yIGNoYWxsYW4gaW4gY2hhbGxhbl9saXN0IGlmIGNoYWxsYW4uZ2V0KCJhbW91bnQiLCB7fSkuZ2V0KCJ0b3RhbCIpKQogICAgcGFpZF9jb3VudCA9IHN1bSgxIGZvciBjaGFsbGFuIGluIGNoYWxsYW5fbGlzdCBpZiBjaGFsbGFuLmdldCgiY2hhbGxhbl9zdGF0dXMiKSA9PSAiUEFJRCIpCiAgICB1bnBhaWRfY291bnQgPSB0b3RhbF9jaGFsbGFucyAtIHBhaWRfY291bnQKICAgIAogICAgc3VtbWFyeV9tc2cgPSBmIvCfmpMgKkNoYWxsYW4gU3VtbWFyeSogKFNvdXJjZToge3NvdXJjZX0pXG5cbiIKICAgIHN1bW1hcnlfbXNnICs9IGYi8J+UoiAqVmVoaWNsZSogICAgICAgIDogYHtkYXRhLmdldCgncmVnaXN0cmF0aW9uJywgcmNfbnVtYmVyKX1gXG4iCiAgICBzdW1tYXJ5X21zZyArPSBmIvCfk4ogKlRvdGFsIENoYWxsYW5zKiA6IGB7dG90YWxfY2hhbGxhbnN9YFxuIgogICAgc3VtbWFyeV9tc2cgKz0gZiLwn5KwICpUb3RhbCBBbW91bnQqICAgOiBg4oK5e3RvdGFsX2Ftb3VudDosLjJmfWBcbiIKICAgIHN1bW1hcnlfbXNnICs9IGYi4pyFICpQYWlkKiAgICAgICAgICAgOiBge3BhaWRfY291bnR9YFxuIgogICAgc3VtbWFyeV9tc2cgKz0gZiLinYwgKlVucGFpZCogICAgICAgICA6IGB7dW5wYWlkX2NvdW50fWBcbiIKICAgIHN1bW1hcnlfbXNnICs9IGYi8J+ThSAqRmV0Y2hlZCBPbiogICAgIDogYHtjaGFsbGFuX2RhdGEuZ2V0KCdmZXRjaGVkX29uJywgZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJykpfWBcblxuIgogICAgc3VtbWFyeV9tc2cgKz0gIuKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxuXG4iCiAgICBzdW1tYXJ5X21zZyArPSAi8J+TiyAqQ2hhbGxhbiBEZXRhaWxzIEJlbG93OipcbiIKICAgIAogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIHN1bW1hcnlfbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAKICAgICMgU2VuZCBlYWNoIGNoYWxsYW4gYXMgc2VwYXJhdGUgbWVzc2FnZSBmb3IgZWFzeSBjb3B5aW5nCiAgICBmb3IgaSwgY2hhbGxhbiBpbiBlbnVtZXJhdGUoY2hhbGxhbl9saXN0LCAxKToKICAgICAgICBjaGFsbGFuX21zZyA9IGYi8J+akyAqQ2hhbGxhbiB7aX0ve3RvdGFsX2NoYWxsYW5zfSpcblxuIgogICAgICAgIAogICAgICAgIGNoYWxsYW5fbXNnICs9IGYi8J+ThCAqQ2hhbGxhbiBObyogICAgOiBge2NoYWxsYW4uZ2V0KCdudW1iZXInLCAnTi9BJyl9YFxuIgogICAgICAgIAogICAgICAgICMgVmlvbGF0aW9uIGRldGFpbHMKICAgICAgICB2aW9sYXRpb25zID0gY2hhbGxhbi5nZXQoInZpb2xhdGlvbnMiLCB7fSkKICAgICAgICBpZiB2aW9sYXRpb25zOgogICAgICAgICAgICBjaGFsbGFuX21zZyArPSBmIvCfk4UgKkRhdGUqICAgICAgICAgIDogYHt2aW9sYXRpb25zLmdldCgnZGF0ZScsICdOL0EnKX1gXG4iCiAgICAgICAgICAgIGNoYWxsYW5fbXNnICs9IGYi8J+RpCAqTmFtZSogICAgICAgICAgOiBge3Zpb2xhdGlvbnMuZ2V0KCduYW1lJywgJ04vQScpfWBcbiIKICAgICAgICAgICAgY2hhbGxhbl9tc2cgKz0gZiLwn5ONICpMb2NhdGlvbiogICAgICA6IGB7dmlvbGF0aW9ucy5nZXQoJ2xvY2F0aW9uJywgJ04vQScpfWBcbiIKICAgICAgICAKICAgICAgICAjIEFtb3VudAogICAgICAgIGFtb3VudF9kYXRhID0gY2hhbGxhbi5nZXQoImFtb3VudCIsIHt9KQogICAgICAgIGlmIGFtb3VudF9kYXRhOgogICAgICAgICAgICBjaGFsbGFuX21zZyArPSBmIvCfkrAgKkFtb3VudCogICAgICAgIDogYOKCuXtmbG9hdChhbW91bnRfZGF0YS5nZXQoJ3RvdGFsJywgMCkpOiwuMmZ9YFxuIgogICAgICAgIAogICAgICAgICMgU3RhdHVzIHdpdGggZW1vamkKICAgICAgICBzdGF0dXMgPSBjaGFsbGFuLmdldCgiY2hhbGxhbl9zdGF0dXMiLCAiVU5LTk9XTiIpCiAgICAgICAgc3RhdHVzX2Vtb2ppID0gIuKchSIgaWYgc3RhdHVzID09ICJQQUlEIiBlbHNlICLinYwiIGlmIHN0YXR1cyA9PSAiVU5QQUlEIiBlbHNlICLinZMiCiAgICAgICAgY2hhbGxhbl9tc2cgKz0gZiLwn5OKICpTdGF0dXMqICAgICAgICA6IHtzdGF0dXNfZW1vaml9IGB7c3RhdHVzfWBcbiIKICAgICAgICAKICAgICAgICAjIFN0YXRlCiAgICAgICAgaWYgY2hhbGxhbi5nZXQoInN0YXRlIik6CiAgICAgICAgICAgIGNoYWxsYW5fbXNnICs9IGYi8J+Pm++4jyAqU3RhdGUqICAgICAgICAgOiBge2NoYWxsYW5bJ3N0YXRlJ119YFxuIgogICAgICAgIAogICAgICAgICMgVmlvbGF0aW9uIG9mZmVuY2VzIChsaXN0IGFsbCkKICAgICAgICB2aW9sYXRpb25zX2xpc3QgPSB2aW9sYXRpb25zLmdldCgiZGV0YWlscyIsIFtdKQogICAgICAgIGlmIHZpb2xhdGlvbnNfbGlzdDoKICAgICAgICAgICAgY2hhbGxhbl9tc2cgKz0gIlxu4pqW77iPICpWaW9sYXRpb25zOipcbiIKICAgICAgICAgICAgZm9yIGosIHZpb2xhdGlvbiBpbiBlbnVtZXJhdGUodmlvbGF0aW9uc19saXN0LCAxKToKICAgICAgICAgICAgICAgIG9mZmVuY2UgPSB2aW9sYXRpb24uZ2V0KCJvZmZlbmNlIiwgIk4vQSIpCiAgICAgICAgICAgICAgICBjaGFsbGFuX21zZyArPSBmIiAge2p9LiBge29mZmVuY2V9YFxuIgogICAgICAgIAogICAgICAgIGNoYWxsYW5fbXNnICs9ICJcbuKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCIKICAgICAgICAKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgY2hhbGxhbl9tc2csIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgIAogICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKCmRlZiBjaGF0X3dpdGhfZGV2KG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgbWFya3VwID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAoKQogICAgYnRuID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfkqwgT3BlbiBDaGF0IiwgdXJsPURFVkVMT1BFUl9MSU5LKQogICAgbWFya3VwLmFkZChidG4pCiAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIvCflKcgWW91IGNhbiBjb250YWN0IHRoZSBkZXZlbG9wZXIgaGVyZSDwn5GHIiwgcmVwbHlfbWFya3VwPW1hcmt1cCkKCmRlZiBiYW5fdXNlcl9jb21tYW5kKG1lc3NhZ2UpOgogICAgIiIiSGFuZGxlIC9iYW4gY29tbWFuZCIiIgogICAgaWYgbWVzc2FnZS5mcm9tX3VzZXIuaWQgIT0gQURNSU5fVVNFUl9JRDoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBZb3UgYXJlIG5vdCBhdXRob3JpemVkIHRvIHVzZSB0aGlzIGNvbW1hbmQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgY29tbWFuZF9wYXJ0cyA9IG1lc3NhZ2UudGV4dC5zcGxpdCgnICcsIDIpCiAgICBpZiBsZW4oY29tbWFuZF9wYXJ0cykgPCAyOgogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAi4p2MIFBsZWFzZSBwcm92aWRlIGEgdXNlciBJRCB0byBiYW4uXG5Vc2FnZTogYC9iYW4gPHVzZXJfaWQ+IFtyZWFzb25dYCIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gaW50KGNvbW1hbmRfcGFydHNbMV0uc3RyaXAoKSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAi4p2MIEludmFsaWQgdXNlciBJRC4gUGxlYXNlIHByb3ZpZGUgYSBudW1lcmljIHVzZXIgSUQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgcmVhc29uID0gY29tbWFuZF9wYXJ0c1syXSBpZiBsZW4oY29tbWFuZF9wYXJ0cykgPiAyIGVsc2UgIk5vIHJlYXNvbiBwcm92aWRlZCIKICAgIAogICAgIyBDaGVjayBpZiB1c2VyIGlzIGFscmVhZHkgYmFubmVkCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgZiLinYwgVXNlciB7dXNlcl9pZH0gaXMgYWxyZWFkeSBiYW5uZWQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgIyBUcnkgdG8gZ2V0IHVzZXIgaW5mbyBmcm9tIGRhdGFiYXNlCiAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KCd1c2Vycy5kYicpCiAgICBjID0gY29ubi5jdXJzb3IoKQogICAgYy5leGVjdXRlKCdTRUxFQ1QgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSBGUk9NIHVzZXJzIFdIRVJFIHVzZXJfaWQgPSA/JywgKHVzZXJfaWQsKSkKICAgIHVzZXJfaW5mbyA9IGMuZmV0Y2hvbmUoKQogICAgY29ubi5jbG9zZSgpCiAgICAKICAgIHVzZXJuYW1lID0gdXNlcl9pbmZvWzBdIGlmIHVzZXJfaW5mbyBlbHNlIE5vbmUKICAgIGZpcnN0X25hbWUgPSB1c2VyX2luZm9bMV0gaWYgdXNlcl9pbmZvIGVsc2UgIlVua25vd24iCiAgICBsYXN0X25hbWUgPSB1c2VyX2luZm9bMl0gaWYgdXNlcl9pbmZvIGVsc2UgIiIKICAgIAogICAgIyBCYW4gdGhlIHVzZXIKICAgIGJhbl91c2VyKHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIG1lc3NhZ2UuZnJvbV91c2VyLmlkLCByZWFzb24pCiAgICAKICAgICMgVHJ5IHRvIHNlbmQgbm90aWZpY2F0aW9uIHRvIHRoZSBiYW5uZWQgdXNlcgogICAgdHJ5OgogICAgICAgIGJhbl9ub3RpZmljYXRpb24gPSBmIvCfmqsgQUNDT1VOVCBCQU5ORURcblxuIgogICAgICAgIGJhbl9ub3RpZmljYXRpb24gKz0gZiJZb3VyIGFjY291bnQgaGFzIGJlZW4gYmFubmVkIGZyb20gdXNpbmcgdGhpcyBib3QuXG5cbiIKICAgICAgICBiYW5fbm90aWZpY2F0aW9uICs9IGYi8J+UkiBSZWFzb246IHtyZWFzb259XG4iCiAgICAgICAgYmFuX25vdGlmaWNhdGlvbiArPSBmIvCfk4UgQmFubmVkIGF0OiB7ZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9XG5cbiIKICAgICAgICBiYW5fbm90aWZpY2F0aW9uICs9IGYi8J+TniBDb250YWN0IE93bmVyOiBAe0FETUlOX1VTRVJOQU1FfVxuIgogICAgICAgIGJhbl9ub3RpZmljYXRpb24gKz0gZiLwn5KsIFRlbGVncmFtOiBodHRwczovL3QubWUve0FETUlOX1VTRVJOQU1FfVxuXG4iCiAgICAgICAgYmFuX25vdGlmaWNhdGlvbiArPSBmIuKaoO+4jyBJZiB5b3UgYmVsaWV2ZSB0aGlzIGlzIGEgbWlzdGFrZSwgY29udGFjdCB0aGUgb3duZXIgdG8gYXBwZWFsLiIKICAgICAgICAKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHVzZXJfaWQsIGJhbl9ub3RpZmljYXRpb24pCiAgICAgICAgdXNlcl9ub3RpZmllZCA9IFRydWUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICB1c2VyX25vdGlmaWVkID0gRmFsc2UKICAgIAogICAgIyBTZW5kIGNvbmZpcm1hdGlvbiB0byBhZG1pbgogICAgZnVsbF9uYW1lID0gZiJ7Zmlyc3RfbmFtZX0ge2xhc3RfbmFtZX0iLnN0cmlwKCkgaWYgZmlyc3RfbmFtZSBvciBsYXN0X25hbWUgZWxzZSAiVW5rbm93biBVc2VyIgogICAgdXNlcl9saW5rID0gZiJAe3VzZXJuYW1lfSIgaWYgdXNlcm5hbWUgZWxzZSBmIlVzZXIgSUQ6IHt1c2VyX2lkfSIKICAgIAogICAgY29uZmlybWF0aW9uX21zZyA9IGYi4pyFIFVzZXIgQmFubmVkIFN1Y2Nlc3NmdWxseVxuXG4iCiAgICBjb25maXJtYXRpb25fbXNnICs9IGYi8J+RpCBVc2VyOiB7dXNlcl9saW5rfVxuIgogICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfk5sgTmFtZToge2Z1bGxfbmFtZX1cbiIKICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn4aUIFVzZXIgSUQ6IHt1c2VyX2lkfVxuIgogICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfk50gUmVhc29uOiB7cmVhc29ufVxuIgogICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfka4gQmFubmVkIGJ5OiBBZG1pblxuIgogICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfk4UgVGltZToge2RhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfVxuIgogICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCflJQgVXNlciBOb3RpZmllZDogeyfinIUgWWVzJyBpZiB1c2VyX25vdGlmaWVkIGVsc2UgJ+KdjCBObyAoVXNlciBtYXkgaGF2ZSBibG9ja2VkIHRoZSBib3QpJ30iCiAgICAKICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCBjb25maXJtYXRpb25fbXNnKQoKZGVmIHVuYmFuX3VzZXJfY29tbWFuZChtZXNzYWdlKToKICAgICIiIkhhbmRsZSAvdW5iYW4gY29tbWFuZCIiIgogICAgaWYgbWVzc2FnZS5mcm9tX3VzZXIuaWQgIT0gQURNSU5fVVNFUl9JRDoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBZb3UgYXJlIG5vdCBhdXRob3JpemVkIHRvIHVzZSB0aGlzIGNvbW1hbmQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgY29tbWFuZF9wYXJ0cyA9IG1lc3NhZ2UudGV4dC5zcGxpdCgnICcsIDEpCiAgICBpZiBsZW4oY29tbWFuZF9wYXJ0cykgPCAyOgogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAi4p2MIFBsZWFzZSBwcm92aWRlIGEgdXNlciBJRCB0byB1bmJhbi5cblVzYWdlOiBgL3VuYmFuIDx1c2VyX2lkPmAiKQogICAgICAgIHJldHVybgogICAgCiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IGludChjb21tYW5kX3BhcnRzWzFdLnN0cmlwKCkpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBJbnZhbGlkIHVzZXIgSUQuIFBsZWFzZSBwcm92aWRlIGEgbnVtZXJpYyB1c2VyIElELiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBhY3R1YWxseSBiYW5uZWQKICAgIGlmIG5vdCBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgZiLinYwgVXNlciB7dXNlcl9pZH0gaXMgbm90IGJhbm5lZC4iKQogICAgICAgIHJldHVybgogICAgCiAgICAjIEdldCB1c2VyIGluZm8gYmVmb3JlIHVuYmFubmluZwogICAgYmFuX2luZm8gPSBnZXRfYmFubmVkX3VzZXJfaW5mbyh1c2VyX2lkKQogICAgCiAgICAjIFVuYmFuIHRoZSB1c2VyCiAgICBpZiB1bmJhbl91c2VyKHVzZXJfaWQpOgogICAgICAgICMgVHJ5IHRvIHNlbmQgbm90aWZpY2F0aW9uIHRvIHRoZSB1bmJhbm5lZCB1c2VyCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1bmJhbl9ub3RpZmljYXRpb24gPSBmIuKchSBBQ0NPVU5UIFVOQkFOTkVEXG5cbiIKICAgICAgICAgICAgdW5iYW5fbm90aWZpY2F0aW9uICs9IGYiWW91ciBhY2NvdW50IGhhcyBiZWVuIHVuYmFubmVkIGZyb20gdGhlIGJvdC5cblxuIgogICAgICAgICAgICB1bmJhbl9ub3RpZmljYXRpb24gKz0gZiLwn5OFIFVuYmFubmVkIGF0OiB7ZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9XG5cbiIKICAgICAgICAgICAgdW5iYW5fbm90aWZpY2F0aW9uICs9IGYi8J+OiSBZb3UgY2FuIG5vdyB1c2UgdGhlIGJvdCBhZ2FpbiFcbiIKICAgICAgICAgICAgdW5iYW5fbm90aWZpY2F0aW9uICs9IGYiVHlwZSAvc3RhcnQgdG8gYmVnaW4uIgogICAgICAgICAgICAKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZSh1c2VyX2lkLCB1bmJhbl9ub3RpZmljYXRpb24pCiAgICAgICAgICAgIHVzZXJfbm90aWZpZWQgPSBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICB1c2VyX25vdGlmaWVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFNlbmQgY29uZmlybWF0aW9uIHRvIGFkbWluCiAgICAgICAgdXNlcm5hbWUgPSBiYW5faW5mb1sxXSBpZiBiYW5faW5mbyBhbmQgbGVuKGJhbl9pbmZvKSA+IDEgZWxzZSBOb25lCiAgICAgICAgZmlyc3RfbmFtZSA9IGJhbl9pbmZvWzJdIGlmIGJhbl9pbmZvIGFuZCBsZW4oYmFuX2luZm8pID4gMiBlbHNlICJVbmtub3duIgogICAgICAgIGxhc3RfbmFtZSA9IGJhbl9pbmZvWzNdIGlmIGJhbl9pbmZvIGFuZCBsZW4oYmFuX2luZm8pID4gMyBlbHNlICIiCiAgICAgICAgCiAgICAgICAgZnVsbF9uYW1lID0gZiJ7Zmlyc3RfbmFtZX0ge2xhc3RfbmFtZX0iLnN0cmlwKCkgaWYgZmlyc3RfbmFtZSBvciBsYXN0X25hbWUgZWxzZSAiVW5rbm93biBVc2VyIgogICAgICAgIHVzZXJfbGluayA9IGYiQHt1c2VybmFtZX0iIGlmIHVzZXJuYW1lIGVsc2UgZiJVc2VyIElEOiB7dXNlcl9pZH0iCiAgICAgICAgCiAgICAgICAgY29uZmlybWF0aW9uX21zZyA9IGYi4pyFIFVzZXIgVW5iYW5uZWQgU3VjY2Vzc2Z1bGx5XG5cbiIKICAgICAgICBjb25maXJtYXRpb25fbXNnICs9IGYi8J+RpCBVc2VyOiB7dXNlcl9saW5rfVxuIgogICAgICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5ObIE5hbWU6IHtmdWxsX25hbWV9XG4iCiAgICAgICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfhpQgVXNlciBJRDoge3VzZXJfaWR9XG4iCiAgICAgICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfka4gVW5iYW5uZWQgYnk6IEFkbWluXG4iCiAgICAgICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfk4UgVGltZToge2RhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfVxuIgogICAgICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5SUIFVzZXIgTm90aWZpZWQ6IHsn4pyFIFllcycgaWYgdXNlcl9ub3RpZmllZCBlbHNlICfinYwgTm8gKFVzZXIgbWF5IGhhdmUgYmxvY2tlZCB0aGUgYm90KSd9IgogICAgICAgIAogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCBjb25maXJtYXRpb25fbXNnKQogICAgZWxzZToKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgZiLinYwgRmFpbGVkIHRvIHVuYmFuIHVzZXIge3VzZXJfaWR9LiBUaGV5IG1heSBub3QgYmUgaW4gdGhlIGJhbm5lZCBsaXN0LiIpCgpkZWYgc2hvd19iYW5uZWRfdXNlcnMobWVzc2FnZSk6CiAgICAiIiJIYW5kbGUgL2Jhbm5lZCBjb21tYW5kIHRvIHNob3cgYWxsIGJhbm5lZCB1c2VycyIiIgogICAgaWYgbWVzc2FnZS5mcm9tX3VzZXIuaWQgIT0gQURNSU5fVVNFUl9JRDoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBZb3UgYXJlIG5vdCBhdXRob3JpemVkIHRvIHVzZSB0aGlzIGNvbW1hbmQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgYmFubmVkX3VzZXJzID0gZ2V0X2FsbF9iYW5uZWRfdXNlcnMoKQogICAgCiAgICBpZiBub3QgYmFubmVkX3VzZXJzOgogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAi8J+TiyBCYW5uZWQgVXNlcnMgTGlzdFxuXG5ObyB1c2VycyBhcmUgY3VycmVudGx5IGJhbm5lZC4g4pyFIikKICAgICAgICByZXR1cm4KICAgIAogICAgbXNnID0gIvCfk4sgQmFubmVkIFVzZXJzIExpc3RcblxuIgogICAgbXNnICs9IGYiVG90YWwgYmFubmVkIHVzZXJzOiB7bGVuKGJhbm5lZF91c2Vycyl9XG5cbiIKICAgIAogICAgZm9yIGksIHVzZXIgaW4gZW51bWVyYXRlKGJhbm5lZF91c2VycywgMSk6CiAgICAgICAgdXNlcl9pZCwgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgYmFubmVkX2F0ID0gdXNlcgogICAgICAgIGZ1bGxfbmFtZSA9IGYie2ZpcnN0X25hbWV9IHtsYXN0X25hbWV9Ii5zdHJpcCgpIGlmIGZpcnN0X25hbWUgb3IgbGFzdF9uYW1lIGVsc2UgIlVua25vd24iCiAgICAgICAgdXNlcl9saW5rID0gZiJAe3VzZXJuYW1lfSIgaWYgdXNlcm5hbWUgZWxzZSBmIklEOiB7dXNlcl9pZH0iCiAgICAgICAgCiAgICAgICAgbXNnICs9IGYie2l9LiB7dXNlcl9saW5rfVxuIgogICAgICAgIG1zZyArPSBmIiAgIPCfkaQgTmFtZToge2Z1bGxfbmFtZX1cbiIKICAgICAgICBtc2cgKz0gZiIgICDwn4aUIElEOiB7dXNlcl9pZH1cbiIKICAgICAgICBtc2cgKz0gZiIgICDwn5OFIEJhbm5lZDoge2Jhbm5lZF9hdH1cbiIKICAgICAgICBtc2cgKz0gIiAgIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxuIgogICAgCiAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgbXNnKQoKZGVmIGJyb2FkY2FzdF9tZXNzYWdlKG1lc3NhZ2UpOgogICAgaWYgbWVzc2FnZS5mcm9tX3VzZXIuaWQgIT0gQURNSU5fVVNFUl9JRDoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBZb3UgYXJlIG5vdCBhdXRob3JpemVkIHRvIHVzZSB0aGlzIGNvbW1hbmQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgY29tbWFuZF9wYXJ0cyA9IG1lc3NhZ2UudGV4dC5zcGxpdCgnICcsIDEpCiAgICBpZiBsZW4oY29tbWFuZF9wYXJ0cykgPCAyOgogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAi4p2MIFBsZWFzZSBwcm92aWRlIGEgbWVzc2FnZSB0byBicm9hZGNhc3QuXG5Vc2FnZTogYC9tc2cgeW91ciBtZXNzYWdlIGhlcmVgIiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIHJldHVybgogICAgCiAgICBicm9hZGNhc3RfdGV4dCA9IGNvbW1hbmRfcGFydHNbMV0KICAgIGJyb2FkY2FzdF9pZCA9IGdlbmVyYXRlX2Jyb2FkY2FzdF9pZCgpCiAgICBicm9hZGNhc3Rfc3RvcmFnZVticm9hZGNhc3RfaWRdID0gYnJvYWRjYXN0X3RleHQKICAgIAogICAgbWFya3VwID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAoKQogICAgY29uZmlybV9idG4gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigi4pyFIFllcywgU2VuZCB0byBBbGwiLCBjYWxsYmFja19kYXRhPWYiYmNfY29uZmlybTp7YnJvYWRjYXN0X2lkfSIpCiAgICBjYW5jZWxfYnRuID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIuKdjCBDYW5jZWwiLCBjYWxsYmFja19kYXRhPSJiY19jYW5jZWwiKQogICAgbWFya3VwLmFkZChjb25maXJtX2J0biwgY2FuY2VsX2J0bikKICAgIAogICAgcHJldmlld190ZXh0ID0gYnJvYWRjYXN0X3RleHRbOjEwMF0gKyAiLi4uIiBpZiBsZW4oYnJvYWRjYXN0X3RleHQpID4gMTAwIGVsc2UgYnJvYWRjYXN0X3RleHQKICAgIAogICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIAogICAgICAgICAgICAgICAgIGYi8J+ToiBCcm9hZGNhc3QgQ29uZmlybWF0aW9uXG5cbiIKICAgICAgICAgICAgICAgICBmIk1lc3NhZ2UgUHJldmlldzoge3ByZXZpZXdfdGV4dH1cblxuIgogICAgICAgICAgICAgICAgIGYiTWVzc2FnZSBMZW5ndGg6IHtsZW4oYnJvYWRjYXN0X3RleHQpfSBjaGFyYWN0ZXJzXG4iCiAgICAgICAgICAgICAgICAgZiJUb3RhbCB1c2Vyczoge2xlbihnZXRfYWxsX3VzZXJzKCkpfVxuXG4iCiAgICAgICAgICAgICAgICAgZiJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gc2VuZCB0aGlzIG1lc3NhZ2UgdG8gYWxsIHVzZXJzPyIsCiAgICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPW1hcmt1cCkKCmRlZiBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCBicm9hZGNhc3RfdGV4dCk6CiAgICAjIFNraXAgYmFubmVkIHVzZXJzIHdoZW4gYnJvYWRjYXN0aW5nCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgdHJ5OgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZCwgCiAgICAgICAgICAgICAgICAgICAgICAgZiLwn5OiIEFubm91bmNlbWVudFxuXG57YnJvYWRjYXN0X3RleHR9XG5cbiIKICAgICAgICAgICAgICAgICAgICAgICBmIuKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgFxuIgogICAgICAgICAgICAgICAgICAgICAgIGYiQm90IFVwZGF0ZSDwn6SWIikKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBzZW5kX2Jyb2FkY2FzdF9zZXF1ZW50aWFsKHVzZXJfaWRzLCBicm9hZGNhc3RfdGV4dCwgY2FsbGJhY2tfbWVzc2FnZSk6CiAgICBzdWNjZXNzX2NvdW50ID0gMAogICAgZmFpbF9jb3VudCA9IDAKICAgIHRvdGFsX3VzZXJzID0gbGVuKHVzZXJfaWRzKQogICAgCiAgICBmb3IgaW5kZXgsIHVzZXJfaWQgaW4gZW51bWVyYXRlKHVzZXJfaWRzLCAxKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbmRfbWVzc2FnZV90b191c2VyKHVzZXJfaWQsIGJyb2FkY2FzdF90ZXh0KToKICAgICAgICAgICAgICAgIHN1Y2Nlc3NfY291bnQgKz0gMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZmFpbF9jb3VudCArPSAxCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBpbmRleCAlIDEwID09IDAgb3IgaW5kZXggPT0gdG90YWxfdXNlcnM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfcGVyY2VudCA9IChpbmRleCAvIHRvdGFsX3VzZXJzKSAqIDEwMAogICAgICAgICAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrX21lc3NhZ2UuZnJvbV91c2VyLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBmIvCfk4ogQnJvYWRjYXN0IFByb2dyZXNzXG5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLwn5SEIFNlbnQ6IHtpbmRleH0ve3RvdGFsX3VzZXJzfVxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIvCfk4ggUHJvZ3Jlc3M6IHtwcm9ncmVzc19wZXJjZW50Oi4xZn0lXG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pyFIFN1Y2Nlc3M6IHtzdWNjZXNzX2NvdW50fVxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKdjCBGYWlsZWQ6IHtmYWlsX2NvdW50fSIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgdGltZS5zbGVlcCgwLjA1KQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBmYWlsX2NvdW50ICs9IDEKICAgIAogICAgdHJ5OgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNhbGxiYWNrX21lc3NhZ2UuZnJvbV91c2VyLmlkLAogICAgICAgICAgICBmIvCfk4ogQnJvYWRjYXN0IENvbXBsZXRlZCFcblxuIgogICAgICAgICAgICBmIuKchSBTdWNjZXNzOiB7c3VjY2Vzc19jb3VudH1cbiIKICAgICAgICAgICAgZiLinYwgRmFpbGVkOiB7ZmFpbF9jb3VudH1cbiIKICAgICAgICAgICAgZiLwn5GlIFRvdGFsOiB7dG90YWxfdXNlcnN9XG4iCiAgICAgICAgICAgIGYi8J+TnSBNZXNzYWdlIExlbmd0aDoge2xlbihicm9hZGNhc3RfdGV4dCl9IGNoYXJhY3RlcnNcbiIKICAgICAgICAgICAgZiLimqEgTWV0aG9kOiBTZXF1ZW50aWFsIHdpdGggcHJvZ3Jlc3MgdXBkYXRlcyIKICAgICAgICApCiAgICBleGNlcHQ6CiAgICAgICAgcGFzcwoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YS5zdGFydHN3aXRoKCdiY18nKSkKZGVmIGhhbmRsZV9icm9hZGNhc3RfY29uZmlybWF0aW9uKGNhbGwpOgogICAgaWYgY2FsbC5kYXRhID09ICdiY19jYW5jZWwnOgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfdGV4dCgi4p2MIEJyb2FkY2FzdCBjYW5jZWxsZWQuIiwgY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGNhbGwubWVzc2FnZS5tZXNzYWdlX2lkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBjYWxsLmRhdGEuc3RhcnRzd2l0aCgnYmNfY29uZmlybTonKToKICAgICAgICBicm9hZGNhc3RfaWQgPSBjYWxsLmRhdGEuc3BsaXQoJ2JjX2NvbmZpcm06JywgMSlbMV0KICAgICAgICBicm9hZGNhc3RfdGV4dCA9IGJyb2FkY2FzdF9zdG9yYWdlLmdldChicm9hZGNhc3RfaWQpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGJyb2FkY2FzdF90ZXh0OgogICAgICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3RleHQoIuKdjCBCcm9hZGNhc3QgbWVzc2FnZSBleHBpcmVkIG9yIG5vdCBmb3VuZC4iLCBjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgY2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGlmIGJyb2FkY2FzdF9pZCBpbiBicm9hZGNhc3Rfc3RvcmFnZToKICAgICAgICAgICAgZGVsIGJyb2FkY2FzdF9zdG9yYWdlW2Jyb2FkY2FzdF9pZF0KICAgICAgICAKICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3RleHQoIuKaoSBTZW5kaW5nIGJyb2FkY2FzdCB0byBhbGwgdXNlcnMuLi4iLCBjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgY2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQpCiAgICAgICAgCiAgICAgICAgdXNlcnMgPSBnZXRfYWxsX3VzZXJzKCkKICAgICAgICAKICAgICAgICBpZiBub3QgdXNlcnM6CiAgICAgICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfdGV4dCgi4p2MIE5vIHVzZXJzIGZvdW5kIGluIGRhdGFiYXNlLiIsIGNhbGwubWVzc2FnZS5jaGF0LmlkLCBjYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgYnJvYWRjYXN0X3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQoCiAgICAgICAgICAgIHRhcmdldD1zZW5kX2Jyb2FkY2FzdF9zZXF1ZW50aWFsLCAKICAgICAgICAgICAgYXJncz0odXNlcnMsIGJyb2FkY2FzdF90ZXh0LCBjYWxsKSwKICAgICAgICAgICAgZGFlbW9uPVRydWUKICAgICAgICApCiAgICAgICAgYnJvYWRjYXN0X3RocmVhZC5zdGFydCgpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2FsbC5mcm9tX3VzZXIuaWQsCiAgICAgICAgICAgICAgICBmIvCfmoAgQnJvYWRjYXN0IFN0YXJ0ZWQhXG5cbiIKICAgICAgICAgICAgICAgIGYi8J+TnSBNZXNzYWdlIGxlbmd0aDoge2xlbihicm9hZGNhc3RfdGV4dCl9IGNoYXJhY3RlcnNcbiIKICAgICAgICAgICAgICAgIGYi8J+RpSBTZW5kaW5nIHRvOiB7bGVuKHVzZXJzKX0gdXNlcnNcbiIKICAgICAgICAgICAgICAgIGYi4pqhIE1ldGhvZDogU2VxdWVudGlhbCB3aXRoIHByb2dyZXNzIHVwZGF0ZXNcblxuIgogICAgICAgICAgICAgICAgZiLij7MgWW91IHdpbGwgcmVjZWl2ZSBwcm9ncmVzcyByZXBvcnRzIGV2ZXJ5IDEwIHVzZXJzLi4uIgogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBUcnVlKQpkZWYgaGFuZGxlX290aGVyX21lc3NhZ2VzKG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZCBiZWZvcmUgc2hvd2luZyBtZW51CiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKCmRlZiBjbGVhbnVwX2Jyb2FkY2FzdF9zdG9yYWdlKCk6CiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRpbWUuc2xlZXAoMzYwMCkKICAgICAgICBnbG9iYWwgYnJvYWRjYXN0X3N0b3JhZ2UKICAgICAgICBicm9hZGNhc3Rfc3RvcmFnZSA9IHt9CgpjbGVhbnVwX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PWNsZWFudXBfYnJvYWRjYXN0X3N0b3JhZ2UpCmNsZWFudXBfdGhyZWFkLmRhZW1vbiA9IFRydWUKY2xlYW51cF90aHJlYWQuc3RhcnQoKQoKcHJpbnQoIvCfpJYgQm90IGlzIHJ1bm5pbmcgIikKCndoaWxlIFRydWU6CiAgICB0cnk6CiAgICAgICAgYm90LnBvbGxpbmcobm9uZV9zdG9wPVRydWUpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHRpbWUuc2xlZXAoNSk=').decode("utf-8"))