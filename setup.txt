import base64
exec(base64.b64decode(b'aW1wb3J0IHRlbGVib3QKZnJvbSB0ZWxlYm90IGltcG9ydCB0eXBlcwppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHRpbWUKaW1wb3J0IHNxbGl0ZTMKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgcmFuZG9tCmltcG9ydCBzdHJpbmcKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKCgpERVZFTE9QRVJfTElOSyA9IGYiaHR0cHM6Ly90Lm1lL3tBRE1JTl9VU0VSTkFNRX0iCiMgQVBJIFVSTHMKTlVNQkVSX0FQSV9VUkwgPSAiaHR0cHM6Ly9hcGkuYjc3YmY5MTEud29ya2Vycy5kZXYvbW9iaWxlP251bWJlcj17fSIKVkVISUNMRV9BUElfVVJMXzEgPSAiaHR0cHM6Ly9hcGkuYjc3YmY5MTEud29ya2Vycy5kZXYvdmVoaWNsZT9yZWdpc3RyYXRpb249e30iClZFSElDTEVfQVBJX1VSTF8yID0gImh0dHBzOi8vYXMtcnVieS1waS52ZXJjZWwuYXBwL3ZlaGljbGU/cmM9e30iCkFBREhBQVJfQVBJX1VSTCA9ICJodHRwczovL2FwaS5iNzdiZjkxMS53b3JrZXJzLmRldi9hYWRoYWFyP2lkPXt9IgoKYm90ID0gdGVsZWJvdC5UZWxlQm90KEJPVF9UT0tFTikKYnJvYWRjYXN0X3N0b3JhZ2UgPSB7fQoKZGVmIGdlbmVyYXRlX2Jyb2FkY2FzdF9pZCgpOgogICAgIiIiR2VuZXJhdGUgcmFuZG9tIGJyb2FkY2FzdCBJRCIiIgogICAgcmV0dXJuICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX2xldHRlcnMgKyBzdHJpbmcuZGlnaXRzLCBrPTgpKQoKZGVmIGluaXRfZGIoKToKICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoJ3VzZXJzLmRiJykKICAgIGMgPSBjb25uLmN1cnNvcigpCiAgICAjIENyZWF0ZSB1c2VycyB0YWJsZQogICAgYy5leGVjdXRlKCcnJ0NSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHVzZXJzCiAgICAgICAgICAgICAgICAgKHVzZXJfaWQgSU5URUdFUiBQUklNQVJZIEtFWSwgdXNlcm5hbWUgVEVYVCwgZmlyc3RfbmFtZSBURVhULCBsYXN0X25hbWUgVEVYVCwgZGF0ZV9qb2luZWQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVApJycnKQogICAgIyBDcmVhdGUgYmFubmVkX3VzZXJzIHRhYmxlCiAgICBjLmV4ZWN1dGUoJycnQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgYmFubmVkX3VzZXJzCiAgICAgICAgICAgICAgICAgKHVzZXJfaWQgSU5URUdFUiBQUklNQVJZIEtFWSwgCiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lIFRFWFQsCiAgICAgICAgICAgICAgICAgIGZpcnN0X25hbWUgVEVYVCwKICAgICAgICAgICAgICAgICAgbGFzdF9uYW1lIFRFWFQsCiAgICAgICAgICAgICAgICAgIGJhbm5lZF9hdCBUSU1FU1RBTVAgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUCwKICAgICAgICAgICAgICAgICAgYmFubmVkX2J5IElOVEVHRVIsCiAgICAgICAgICAgICAgICAgIHJlYXNvbiBURVhUIERFRkFVTFQgJ05vIHJlYXNvbiBwcm92aWRlZCcpJycnKQogICAgY29ubi5jb21taXQoKQogICAgY29ubi5jbG9zZSgpCgpkZWYgc2F2ZV91c2VyKHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUpOgogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnJydJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIHVzZXJzICh1c2VyX2lkLCB1c2VybmFtZSwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lKSAKICAgICAgICAgICAgICAgICBWQUxVRVMgKD8sID8sID8sID8pJycnLCAodXNlcl9pZCwgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSkpCiAgICBjb25uLmNvbW1pdCgpCiAgICBjb25uLmNsb3NlKCkKCmRlZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICIiIkNoZWNrIGlmIHVzZXIgaXMgYmFubmVkIiIiCiAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KCd1c2Vycy5kYicpCiAgICBjID0gY29ubi5jdXJzb3IoKQogICAgYy5leGVjdXRlKCdTRUxFQ1QgKiBGUk9NIGJhbm5lZF91c2VycyBXSEVSRSB1c2VyX2lkID0gPycsICh1c2VyX2lkLCkpCiAgICByZXN1bHQgPSBjLmZldGNob25lKCkKICAgIGNvbm4uY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdCBpcyBub3QgTm9uZQoKZGVmIGdldF9iYW5uZWRfdXNlcl9pbmZvKHVzZXJfaWQpOgogICAgIiIiR2V0IGJhbm5lZCB1c2VyIGluZm9ybWF0aW9uIiIiCiAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KCd1c2Vycy5kYicpCiAgICBjID0gY29ubi5jdXJzb3IoKQogICAgYy5leGVjdXRlKCdTRUxFQ1QgKiBGUk9NIGJhbm5lZF91c2VycyBXSEVSRSB1c2VyX2lkID0gPycsICh1c2VyX2lkLCkpCiAgICByZXN1bHQgPSBjLmZldGNob25lKCkKICAgIGNvbm4uY2xvc2UoKQogICAgcmV0dXJuIHJlc3VsdAoKZGVmIGJhbl91c2VyKHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIGJhbm5lZF9ieSwgcmVhc29uPU5vbmUpOgogICAgIiIiQmFuIGEgdXNlciIiIgogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnJydJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGJhbm5lZF91c2VycyAKICAgICAgICAgICAgICAgICAodXNlcl9pZCwgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgYmFubmVkX2J5LCByZWFzb24pIAogICAgICAgICAgICAgICAgIFZBTFVFUyAoPywgPywgPywgPywgPywgPyknJycsIAogICAgICAgICAgICAgICAgICh1c2VyX2lkLCB1c2VybmFtZSwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBiYW5uZWRfYnksIHJlYXNvbikpCiAgICBjb25uLmNvbW1pdCgpCiAgICBjb25uLmNsb3NlKCkKICAgIHJldHVybiBUcnVlCgpkZWYgdW5iYW5fdXNlcih1c2VyX2lkKToKICAgICIiIlVuYmFuIGEgdXNlciIiIgogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnREVMRVRFIEZST00gYmFubmVkX3VzZXJzIFdIRVJFIHVzZXJfaWQgPSA/JywgKHVzZXJfaWQsKSkKICAgIGNvbm4uY29tbWl0KCkKICAgIGFmZmVjdGVkID0gYy5yb3djb3VudAogICAgY29ubi5jbG9zZSgpCiAgICByZXR1cm4gYWZmZWN0ZWQgPiAwCgpkZWYgZ2V0X2FsbF9iYW5uZWRfdXNlcnMoKToKICAgICIiIkdldCBhbGwgYmFubmVkIHVzZXJzIiIiCiAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KCd1c2Vycy5kYicpCiAgICBjID0gY29ubi5jdXJzb3IoKQogICAgYy5leGVjdXRlKCdTRUxFQ1QgdXNlcl9pZCwgdXNlcm5hbWUsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgYmFubmVkX2F0IEZST00gYmFubmVkX3VzZXJzJykKICAgIHVzZXJzID0gYy5mZXRjaGFsbCgpCiAgICBjb25uLmNsb3NlKCkKICAgIHJldHVybiB1c2VycwoKZGVmIGdldF9hbGxfdXNlcnMoKToKICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoJ3VzZXJzLmRiJykKICAgIGMgPSBjb25uLmN1cnNvcigpCiAgICBjLmV4ZWN1dGUoJ1NFTEVDVCB1c2VyX2lkIEZST00gdXNlcnMnKQogICAgdXNlcnMgPSBbcm93WzBdIGZvciByb3cgaW4gYy5mZXRjaGFsbCgpXQogICAgY29ubi5jbG9zZSgpCiAgICByZXR1cm4gdXNlcnMKCmluaXRfZGIoKQoKZGVmIGZldGNoX251bWJlcl9pbmZvX2Zyb21fYXBpKG1vYmlsZV9udW1iZXIpOgogICAgIiIiCiAgICBGZXRjaCBudW1iZXIgaW5mbyBmcm9tIHByaW1hcnkgQVBJICh1cGRhdGVkIHJlc3BvbnNlIHN0cnVjdHVyZSkKICAgICIiIgogICAgdHJ5OgogICAgICAgIGFwaV91cmwgPSBOVU1CRVJfQVBJX1VSTC5mb3JtYXQobW9iaWxlX251bWJlcikKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChhcGlfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgIAogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaGVjayBuZXcgcmVzcG9uc2Ugc3RydWN0dXJlCiAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICAjIE5ldyBzdHJ1Y3R1cmU6IGRhdGEgLT4gZGF0YSAtPiBzdWNjZXNzIC0+IHJlc3VsdAogICAgICAgICAgICAgICAgaWYgImRhdGEiIGluIGRhdGEgYW5kIGlzaW5zdGFuY2UoZGF0YVsiZGF0YSJdLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICBpbm5lcl9kYXRhID0gZGF0YVsiZGF0YSJdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgImRhdGEiIGluIGlubmVyX2RhdGEgYW5kIGlzaW5zdGFuY2UoaW5uZXJfZGF0YVsiZGF0YSJdLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0X2RhdGEgPSBpbm5lcl9kYXRhWyJkYXRhIl0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlc3VsdF9kYXRhLmdldCgic3VjY2VzcyIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0X2NvbnRlbnQgPSByZXN1bHRfZGF0YS5nZXQoInJlc3VsdCIsIFtdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdF9jb250ZW50LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiByZXN1bHRfY29udGVudC5nZXQoIm1lc3NhZ2UiKSA9PSAiTm8gcmVjb3JkcyBmb3VuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJub19kYXRhIiwgIm1lc3NhZ2UiOiAiTm8gZGF0YSBmb3VuZCBmb3IgdGhpcyBudW1iZXIifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdF9jb250ZW50LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiByZXN1bHRfY29udGVudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MiLCAiZGF0YSI6IHJlc3VsdF9jb250ZW50LCAic291cmNlIjogIkFQSSJ9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogIm5vX2RhdGEiLCAibWVzc2FnZSI6ICJObyBkYXRhIGZvdW5kIGZvciB0aGlzIG51bWJlciJ9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBBbHRlcm5hdGl2ZSBwYXRoOiBjaGVjayBpZiB0aGVyZSdzIGEgInJlc3VsdCIgZGlyZWN0bHkKICAgICAgICAgICAgICAgICAgICBlbGlmICJyZXN1bHQiIGluIGlubmVyX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdF9jb250ZW50ID0gaW5uZXJfZGF0YVsicmVzdWx0Il0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmVzdWx0X2NvbnRlbnQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVzdWx0X2NvbnRlbnQuZ2V0KCJtZXNzYWdlIikgPT0gIk5vIHJlY29yZHMgZm91bmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJub19kYXRhIiwgIm1lc3NhZ2UiOiAiTm8gZGF0YSBmb3VuZCBmb3IgdGhpcyBudW1iZXIifQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXN1bHRfY29udGVudCwgbGlzdCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiByZXN1bHRfY29udGVudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAic3VjY2VzcyIsICJkYXRhIjogcmVzdWx0X2NvbnRlbnQsICJzb3VyY2UiOiAiQVBJIn0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogIm5vX2RhdGEiLCAibWVzc2FnZSI6ICJObyBkYXRhIGZvdW5kIGZvciB0aGlzIG51bWJlciJ9CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4geyJlcnJvciI6ICJBUEkgcmV0dXJuZWQgdW5zdWNjZXNzZnVsIHN0YXR1cyIsICJzb3VyY2UiOiAiQVBJIn0KICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4geyJlcnJvciI6IGYiQVBJIHJldHVybmVkIHN0YXR1cyBjb2RlOiB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9IiwgInNvdXJjZSI6ICJBUEkifQogICAgICAgICAgICAKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4geyJlcnJvciI6IGYiRXJyb3IgZmV0Y2hpbmcgZGF0YToge3N0cihlKX0iLCAic291cmNlIjogIkFQSSJ9CgpkZWYgZmV0Y2hfdmVoaWNsZV9pbmZvX2Zyb21fYXBpKHJjX251bWJlcik6CiAgICAiIiIKICAgIEZldGNoIHZlaGljbGUgaW5mbyBmcm9tIEFQSXMgaW4gc2VxdWVuY2UgKEFQSTEgdGhlbiBBUEkyKQogICAgUmV0dXJucyB2ZWhpY2xlIGluZm8gb25seSAobm8gY2hhbGxhbiBpbmZvKQogICAgIiIiCiAgICAjIFRyeSBBUEkgMSBmaXJzdAogICAgdHJ5OgogICAgICAgIGFwaV91cmwgPSBWRUhJQ0xFX0FQSV9VUkxfMS5mb3JtYXQocmNfbnVtYmVyKQogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGFwaV91cmwsIHRpbWVvdXQ9MTApCiAgICAgICAgCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkYXRhLmdldCgic3VjY2VzcyIpOgogICAgICAgICAgICAgICAgIyBFeHRyYWN0IHZlaGljbGUgaW5mbyBmcm9tIEFQSSAxIHJlc3BvbnNlCiAgICAgICAgICAgICAgICB2ZWhpY2xlX2luZm8gPSB7CiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAic291cmNlIjogIkFQSSAxIiwKICAgICAgICAgICAgICAgICAgICAicmVnaXN0cmF0aW9uIjogZGF0YS5nZXQoInJlZ2lzdHJhdGlvbiIsIHJjX251bWJlciksCiAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBkYXRhLmdldCgic3VjY2VzcyIsIEZhbHNlKSwKICAgICAgICAgICAgICAgICAgICAiYWRkcmVzcyI6IGRhdGEuZ2V0KCJhZGRyZXNzIiwge30pLAogICAgICAgICAgICAgICAgICAgICJjaGFsbGFuIjogZGF0YS5nZXQoImNoYWxsYW4iLCB7fSkgICMgV2lsbCBiZSBpZ25vcmVkIGluIGRpc3BsYXkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2ZWhpY2xlX2luZm8KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIkFQSSAxIGZhaWxlZDoge3N0cihlKX0iKQogICAgCiAgICAjIFRyeSBBUEkgMiBpZiBBUEkgMSBmYWlsZWQKICAgIHRyeToKICAgICAgICBhcGlfdXJsID0gVkVISUNMRV9BUElfVVJMXzIuZm9ybWF0KHJjX251bWJlcikKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChhcGlfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgIAogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGF0YS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgICMgRXh0cmFjdCB2ZWhpY2xlIGluZm8gZnJvbSBBUEkgMiByZXNwb25zZQogICAgICAgICAgICAgICAgdmVoaWNsZV9pbmZvID0gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgICAgICAgInNvdXJjZSI6ICJBUEkgMiIsCiAgICAgICAgICAgICAgICAgICAgInJlZ2lzdHJhdGlvbiI6IHJjX251bWJlciwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGRhdGEuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpLAogICAgICAgICAgICAgICAgICAgICJhZGRyZXNzIjogZGF0YS5nZXQoInZlaGljbGUiLCB7fSksCiAgICAgICAgICAgICAgICAgICAgImNoYWxsYW4iOiB7ImRhdGEiOiBkYXRhLmdldCgiY2hhbGxhbnMiLCBbXSl9ICAjIFdpbGwgYmUgaWdub3JlZCBpbiBkaXNwbGF5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmVoaWNsZV9pbmZvCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJBUEkgMiBmYWlsZWQ6IHtzdHIoZSl9IikKICAgIAogICAgIyBCb3RoIEFQSXMgZmFpbGVkCiAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJGYWlsZWQgdG8gZmV0Y2ggdmVoaWNsZSBpbmZvcm1hdGlvbiBmcm9tIGFsbCBzb3VyY2VzIn0KCmRlZiBmZXRjaF9jaGFsbGFuX2luZm9fZnJvbV9hcGkocmNfbnVtYmVyKToKICAgICIiIgogICAgRmV0Y2ggY2hhbGxhbiBpbmZvIGZyb20gQVBJcyBpbiBzZXF1ZW5jZSAoQVBJMSB0aGVuIEFQSTIpCiAgICBSZXR1cm5zIG9ubHkgY2hhbGxhbiBpbmZvcm1hdGlvbgogICAgIiIiCiAgICAjIFRyeSBBUEkgMSBmaXJzdAogICAgdHJ5OgogICAgICAgIGFwaV91cmwgPSBWRUhJQ0xFX0FQSV9VUkxfMS5mb3JtYXQocmNfbnVtYmVyKQogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGFwaV91cmwsIHRpbWVvdXQ9MTApCiAgICAgICAgCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkYXRhLmdldCgic3VjY2VzcyIpOgogICAgICAgICAgICAgICAgY2hhbGxhbl9kYXRhID0gZGF0YS5nZXQoImNoYWxsYW4iLCB7fSkKICAgICAgICAgICAgICAgIGlmIGNoYWxsYW5fZGF0YSBhbmQgImRhdGEiIGluIGNoYWxsYW5fZGF0YSBhbmQgY2hhbGxhbl9kYXRhWyJkYXRhIl06CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgInNvdXJjZSI6ICJBUEkgMSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZWdpc3RyYXRpb24iOiBkYXRhLmdldCgicmVnaXN0cmF0aW9uIiwgcmNfbnVtYmVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgImNoYWxsYW4iOiBjaGFsbGFuX2RhdGEKICAgICAgICAgICAgICAgICAgICB9CiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJBUEkgMSBmYWlsZWQ6IHtzdHIoZSl9IikKICAgIAogICAgIyBUcnkgQVBJIDIgaWYgQVBJIDEgZmFpbGVkIG9yIGhhcyBubyBjaGFsbGFuIGRhdGEKICAgIHRyeToKICAgICAgICBhcGlfdXJsID0gVkVISUNMRV9BUElfVVJMXzIuZm9ybWF0KHJjX251bWJlcikKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChhcGlfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgIAogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGF0YS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgIGNoYWxsYW5zID0gZGF0YS5nZXQoImNoYWxsYW5zIiwgW10pCiAgICAgICAgICAgICAgICBpZiBjaGFsbGFuczoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogInN1Y2Nlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAic291cmNlIjogIkFQSSAyIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlZ2lzdHJhdGlvbiI6IHJjX251bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgImNoYWxsYW4iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGF0YSI6IGNoYWxsYW5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZldGNoZWRfb24iOiBkYXRldGltZS5ub3coKS5pc29mb3JtYXQoKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiQVBJIDIgZmFpbGVkOiB7c3RyKGUpfSIpCiAgICAKICAgICMgQm90aCBBUElzIGZhaWxlZCBvciBubyBjaGFsbGFuIGRhdGEKICAgIHJldHVybiB7InN0YXR1cyI6ICJub19kYXRhIiwgIm1lc3NhZ2UiOiAiTm8gY2hhbGxhbiByZWNvcmRzIGZvdW5kIGZvciB0aGlzIHZlaGljbGUifQoKZGVmIGZldGNoX2FhZGhhYXJfaW5mb19mcm9tX2FwaShhYWRoYWFyX251bWJlcik6CiAgICB0cnk6CiAgICAgICAgYXBpX3VybCA9IEFBREhBQVJfQVBJX1VSTC5mb3JtYXQoYWFkaGFhcl9udW1iZXIpCiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoYXBpX3VybCwgdGltZW91dD0xMCkKICAgICAgICAKICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgaWYgZGF0YS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgIHJlc3VsdF9kYXRhID0gZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgICAgIGlmIHJlc3VsdF9kYXRhLmdldCgic3VjY2VzcyIpOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdF9jb250ZW50ID0gcmVzdWx0X2RhdGEuZ2V0KCJyZXN1bHQiLCBbXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdF9jb250ZW50LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVzdWx0X2NvbnRlbnQuZ2V0KCJtZXNzYWdlIikgPT0gIk5vIHJlY29yZHMgZm91bmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogIm5vX2RhdGEiLCAibWVzc2FnZSI6ICJObyBkYXRhIGZvdW5kIGZvciB0aGlzIEFhZGhhYXIgbnVtYmVyIn0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdF9jb250ZW50LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVzdWx0X2NvbnRlbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAic3VjY2VzcyIsICJkYXRhIjogcmVzdWx0X2NvbnRlbnR9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAibm9fZGF0YSIsICJtZXNzYWdlIjogIk5vIGRhdGEgZm91bmQgZm9yIHRoaXMgQWFkaGFhciBudW1iZXIifQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJub19kYXRhIiwgIm1lc3NhZ2UiOiAiTm8gZGF0YSBmb3VuZCBmb3IgdGhpcyBBYWRoYWFyIG51bWJlciJ9CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7ImVycm9yIjogIkFQSSByZXR1cm5lZCB1bnN1Y2Nlc3NmdWwgc3RhdHVzIGluIGRhdGEifQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHsiZXJyb3IiOiAiQVBJIHJldHVybmVkIHVuc3VjY2Vzc2Z1bCBzdGF0dXMifQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiB7ImVycm9yIjogZiJBUEkgcmV0dXJuZWQgc3RhdHVzIGNvZGU6IHtyZXNwb25zZS5zdGF0dXNfY29kZX0ifQogICAgICAgICAgICAKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4geyJlcnJvciI6IGYiRXJyb3IgZmV0Y2hpbmcgZGF0YToge3N0cihlKX0ifQoKZGVmIGZvcm1hdF9hZGRyZXNzKGFkZHJlc3Nfc3RyaW5nKToKICAgIGlmIG5vdCBhZGRyZXNzX3N0cmluZyBvciBhZGRyZXNzX3N0cmluZyA9PSAiTi9BIjoKICAgICAgICByZXR1cm4gIk4vQSIKICAgIGZvcm1hdHRlZF9hZGRyZXNzID0gYWRkcmVzc19zdHJpbmcucmVwbGFjZSgnISEhIScsICcsICcpLnJlcGxhY2UoJyEhIScsICcsICcpLnJlcGxhY2UoJyEhJywgJywgJykucmVwbGFjZSgnIScsICcsICcpCiAgICByZXR1cm4gZm9ybWF0dGVkX2FkZHJlc3MKCmRlZiBzaG93X21lbnUoY2hhdF9pZCk6CiAgICBtYXJrdXAgPSB0eXBlcy5SZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCByb3dfd2lkdGg9MikKICAgIG51bV9idG4gPSB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+UoiBOdW0gSW5mbyIpCiAgICBhZGhhcl9idG4gPSB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+GlCBBZGhhciBJbmZvIikKICAgIHZlaGljbGVfYnRuID0gdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfmpcgVmVoaWNsZSBJbmZvIikKICAgIGNoYWxsYW5fYnRuID0gdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfmpMgQ2hhbGxhbiBJbmZvIikKICAgIGRldl9idG4gPSB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+SrCBDaGF0IHdpdGggRGV2ZWxvcGVyIikKICAgIAogICAgbWFya3VwLmFkZChudW1fYnRuLCBhZGhhcl9idG4pCiAgICBtYXJrdXAuYWRkKHZlaGljbGVfYnRuLCBjaGFsbGFuX2J0bikKICAgIG1hcmt1cC5hZGQoZGV2X2J0bikgICMgU2luZ2xlIGJ1dHRvbiBvbiB0aGlyZCByb3csIGNlbnRlcmVkCiAgICAKICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIuKchSBDaG9vc2UgYW4gb3B0aW9uIGJlbG93OiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIiwgcmVwbHlfbWFya3VwPW1hcmt1cCkKCmRlZiBzaG93X3RpcF9tZXNzYWdlKGNoYXRfaWQsIGZvdW5kX2FhZGhhYXI9Tm9uZSk6CiAgICB0aXBfbXNnID0gIvCfkqEgKlBybyBUaXA6KlxuXG4iCiAgICAKICAgIGlmIGZvdW5kX2FhZGhhYXI6CiAgICAgICAgdGlwX21zZyArPSBmIvCfk4QgKkFhZGhhYXIgSUQgRm91bmQ6KiBge2ZvdW5kX2FhZGhhYXJ9YFxuXG4iCiAgICAgICAgdGlwX21zZyArPSAiWW91IGNhbiB1c2UgdGhpcyBBYWRoYWFyIElEIHRvOlxuIgogICAgICAgIHRpcF9tc2cgKz0gIuKAoiDwn5SNIEdldCBtb3JlIHBob25lIG51bWJlcnMgcmVsYXRlZCB0byB0aGlzIHBlcnNvbiAo8J+GlCBBZGhhciBJbmZvKVxuIgogICAgICAgIHRpcF9tc2cgKz0gIuKAoiDwn5qXIEZpbmQgdmVoaWNsZSBkZXRhaWxzIGlmIHJlZ2lzdGVyZWQgKPCfmpcgVmVoaWNsZSBJbmZvKVxuIgogICAgICAgIHRpcF9tc2cgKz0gIuKAoiDwn5qTIENoZWNrIGZvciBhbnkgY2hhbGxhbnMgKPCfmpMgQ2hhbGxhbiBJbmZvKVxuXG4iCiAgICBlbHNlOgogICAgICAgIHRpcF9tc2cgKz0gIklmIHlvdSBoYXZlIGFuIEFhZGhhYXIgSUQsIHlvdSBjYW46XG4iCiAgICAgICAgdGlwX21zZyArPSAi4oCiIPCflI0gRmluZCBtdWx0aXBsZSBwaG9uZSBudW1iZXJzICjwn4aUIEFkaGFyIEluZm8pXG4iCiAgICAgICAgdGlwX21zZyArPSAi4oCiIPCfmpcgR2V0IHZlaGljbGUgZGV0YWlscyAo8J+alyBWZWhpY2xlIEluZm8pXG4iCiAgICAgICAgdGlwX21zZyArPSAi4oCiIPCfmpMgQ2hlY2sgZm9yIGNoYWxsYW5zICjwn5qTIENoYWxsYW4gSW5mbylcblxuIgogICAgCiAgICB0aXBfbXNnICs9ICJUcnkgdGhlc2Ugb3B0aW9ucyBmb3IgY29tcHJlaGVuc2l2ZSBpbmZvcm1hdGlvbiEg8J+agCIKICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgdGlwX21zZywgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQoKZGVmIGNoZWNrX2Jhbl9zdGF0dXModXNlcl9pZCwgY2hhdF9pZCk6CiAgICAiIiJDaGVjayBpZiB1c2VyIGlzIGJhbm5lZCBhbmQgc2VuZCBtZXNzYWdlIGlmIHRoZXkgYXJlIiIiCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICBiYW5faW5mbyA9IGdldF9iYW5uZWRfdXNlcl9pbmZvKHVzZXJfaWQpCiAgICAgICAgYmFuX21zZyA9IGYi8J+aqyBBQ0NFU1MgREVOSUVEXG5cbiIKICAgICAgICBiYW5fbXNnICs9IGYiWW91IGhhdmUgYmVlbiBiYW5uZWQgZnJvbSB1c2luZyB0aGlzIGJvdC5cblxuIgogICAgICAgIGJhbl9tc2cgKz0gZiLwn5SSIFJlYXNvbjogQWNjb3VudCByZXN0cmljdGVkIGJ5IG93bmVyXG4iCiAgICAgICAgYmFuX21zZyArPSBmIvCfk4UgQmFubmVkIGF0OiB7YmFuX2luZm9bNF0gaWYgYmFuX2luZm8gYW5kIGxlbihiYW5faW5mbykgPiA0IGVsc2UgJ1Vua25vd24nfVxuXG4iCiAgICAgICAgYmFuX21zZyArPSBmIvCfk54gQ29udGFjdCBPd25lcjogQHtBRE1JTl9VU0VSTkFNRX1cbiIKICAgICAgICBiYW5fbXNnICs9IGYi8J+SrCBUZWxlZ3JhbTogaHR0cHM6Ly90Lm1lL3tBRE1JTl9VU0VSTkFNRX1cblxuIgogICAgICAgIGJhbl9tc2cgKz0gZiLimqDvuI8gSWYgeW91IGJlbGlldmUgdGhpcyBpcyBhIG1pc3Rha2UsIGNvbnRhY3QgdGhlIG93bmVyIHRvIGFwcGVhbC4iCiAgICAgICAgCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCBiYW5fbXNnKQogICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnc3RhcnQnLCAnbXNnJywgJ2JhbicsICd1bmJhbicsICdiYW5uZWQnXSkKZGVmIGhhbmRsZV9jb21tYW5kcyhtZXNzYWdlKToKICAgIGlmIG1lc3NhZ2UudGV4dC5zdGFydHN3aXRoKCcvc3RhcnQnKToKICAgICAgICBzdGFydChtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnL21zZycpOgogICAgICAgIGJyb2FkY2FzdF9tZXNzYWdlKG1lc3NhZ2UpCiAgICBlbGlmIG1lc3NhZ2UudGV4dC5zdGFydHN3aXRoKCcvYmFuJyk6CiAgICAgICAgYmFuX3VzZXJfY29tbWFuZChtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnL3VuYmFuJyk6CiAgICAgICAgdW5iYW5fdXNlcl9jb21tYW5kKG1lc3NhZ2UpCiAgICBlbGlmIG1lc3NhZ2UudGV4dC5zdGFydHN3aXRoKCcvYmFubmVkJyk6CiAgICAgICAgc2hvd19iYW5uZWRfdXNlcnMobWVzc2FnZSkKCmRlZiBzdGFydChtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQgYmVmb3JlIGFsbG93aW5nIHN0YXJ0CiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBzYXZlX3VzZXIobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuZnJvbV91c2VyLnVzZXJuYW1lLCAKICAgICAgICAgICAgICBtZXNzYWdlLmZyb21fdXNlci5maXJzdF9uYW1lLCBtZXNzYWdlLmZyb21fdXNlci5sYXN0X25hbWUpCiAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5GLIEkgY2FuIGZpbmQgTnVtYmVyIEluZm8sIEFhZGhhYXIgSW5mbywgVmVoaWNsZSBJbmZvLCBhbmQgQ2hhbGxhbiBJbmZvLiBKdXN0IGNob29zZSBhbiBvcHRpb24gYmVsb3chIiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogbWVzc2FnZS50ZXh0IGluIFsi8J+UoiBOdW0gSW5mbyIsICLwn4aUIEFkaGFyIEluZm8iLCAi8J+alyBWZWhpY2xlIEluZm8iLCAi8J+akyBDaGFsbGFuIEluZm8iLCAi8J+SrCBDaGF0IHdpdGggRGV2ZWxvcGVyIl0pCmRlZiBoYW5kbGVfbWVudV9idXR0b25zKG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZCBiZWZvcmUgcHJvY2Vzc2luZyBhbnkgbWVudSBidXR0b24KICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIG1lc3NhZ2UudGV4dCA9PSAi8J+UoiBOdW0gSW5mbyI6CiAgICAgICAgYXNrX251bWJlcihtZXNzYWdlKQogICAgZWxpZiBtZXNzYWdlLnRleHQgPT0gIvCfhpQgQWRoYXIgSW5mbyI6CiAgICAgICAgYXNrX2FhZGhhYXJfbnVtYmVyKG1lc3NhZ2UpCiAgICBlbGlmIG1lc3NhZ2UudGV4dCA9PSAi8J+alyBWZWhpY2xlIEluZm8iOgogICAgICAgIGFza192ZWhpY2xlX3JjKG1lc3NhZ2UpCiAgICBlbGlmIG1lc3NhZ2UudGV4dCA9PSAi8J+akyBDaGFsbGFuIEluZm8iOgogICAgICAgIGFza19jaGFsbGFuX3JjKG1lc3NhZ2UpCiAgICBlbGlmIG1lc3NhZ2UudGV4dCA9PSAi8J+SrCBDaGF0IHdpdGggRGV2ZWxvcGVyIjoKICAgICAgICBjaGF0X3dpdGhfZGV2KG1lc3NhZ2UpCgpkZWYgYXNrX251bWJlcihtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQKICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi8J+TsSBQbGVhc2UgZW50ZXIgYSAqMTAtZGlnaXQqIG1vYmlsZSBudW1iZXI6IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19udW1iZXJfaW5wdXQpCgpkZWYgcHJvY2Vzc19udW1iZXJfaW5wdXQobWVzc2FnZSk6CiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYmFubmVkCiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnLycpIG9yIG1lc3NhZ2UudGV4dCBpbiBbIvCflKIgTnVtIEluZm8iLCAi8J+GlCBBZGhhciBJbmZvIiwgIvCfmpcgVmVoaWNsZSBJbmZvIiwgIvCfmpMgQ2hhbGxhbiBJbmZvIiwgIvCfkqwgQ2hhdCB3aXRoIERldmVsb3BlciJdOgogICAgICAgIGJvdC5wcm9jZXNzX25ld19tZXNzYWdlcyhbbWVzc2FnZV0pCiAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICBpZiBub3QgKG1lc3NhZ2UudGV4dC5pc2RpZ2l0KCkgYW5kIGxlbihtZXNzYWdlLnRleHQpID09IDEwKToKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBJbnZhbGlkIG51bWJlciEgUGxlYXNlIGVudGVyIGEgKjEwLWRpZ2l0KiBtb2JpbGUgbnVtYmVyOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgICAgICBib3QucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBwcm9jZXNzX251bWJlcl9pbnB1dCkKICAgICAgICByZXR1cm4KICAgIAogICAgc2F2ZV91c2VyKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmZyb21fdXNlci51c2VybmFtZSwgCiAgICAgICAgICAgICAgbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZSwgbWVzc2FnZS5mcm9tX3VzZXIubGFzdF9uYW1lKQogICAgCiAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIvCflI4gRmV0Y2hpbmcgZGV0YWlscy4uLiBQbGVhc2Ugd2FpdCDij7MiKQogICAgCiAgICBkYXRhID0gZmV0Y2hfbnVtYmVyX2luZm9fZnJvbV9hcGkobWVzc2FnZS50ZXh0KQogICAgCiAgICBpZiAiZXJyb3IiIGluIGRhdGE6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIEVycm9yIGZyb20ge2RhdGEuZ2V0KCdzb3VyY2UnLCAnQVBJJyl9OiB7ZGF0YVsnZXJyb3InXX0iLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpID09ICJub19kYXRhIjoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiLinYwge2RhdGEuZ2V0KCdtZXNzYWdlJywgJ05vIGRhdGEgZm91bmQgZm9yIHRoaXMgbnVtYmVyIGFmdGVyIHRyeWluZyBhbGwgYXZhaWxhYmxlIHNvdXJjZXMuJyl9IikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgIT0gInN1Y2Nlc3MiOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIE5vIGRhdGEgZm91bmQgZm9yIHRoaXMgbnVtYmVyLiIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgcmVzdWx0cyA9IGRhdGEuZ2V0KCJkYXRhIiwgW10pCiAgICBhcGlfc291cmNlID0gZGF0YS5nZXQoInNvdXJjZSIsICJBUEkiKQogICAgCiAgICBpZiBub3QgcmVzdWx0czoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBObyBkYXRhIGZvdW5kIGZvciB0aGlzIG51bWJlci4iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICBmb3VuZF9hYWRoYWFycyA9IHNldCgpCiAgICBmb3IgaSwgcCBpbiBlbnVtZXJhdGUocmVzdWx0cywgMSk6CiAgICAgICAgbXNnID0gKAogICAgICAgICAgICBmIvCfk7IgKlVzZXIgSW5mb3JtYXRpb24qIChTb3VyY2U6IHthcGlfc291cmNlfSlcblxuIgogICAgICAgICAgICBmIvCfk54gKk1vYmlsZSBObyogICAgIDogYHtwLmdldCgnbW9iaWxlJywnTi9BJyl9YFxuIgogICAgICAgICAgICBmIvCfkaggKk5hbWUqICAgICAgICAgIDogYHtwLmdldCgnbmFtZScsJ04vQScpfWBcbiIKICAgICAgICAgICAgZiLwn5G0ICpGYXRoZXIgTmFtZSogICA6IGB7cC5nZXQoJ2ZhdGhlcl9uYW1lJywnTi9BJyl9YFxuIgogICAgICAgICAgICBmIvCfj6AgKkFkZHJlc3MqICAgICAgIDogYHtmb3JtYXRfYWRkcmVzcyhwLmdldCgnYWRkcmVzcycsJ04vQScpKX1gXG4iCiAgICAgICAgICAgIGYi8J+WhCAqQWFkaGFyIElEKiAgICAgOiBge3AuZ2V0KCdpZF9udW1iZXInLCdOL0EnKX1gXG4iCiAgICAgICAgICAgIGYi8J+TsSAqQWx0IE1vYmlsZSogICAgOiBge3AuZ2V0KCdhbHRfbW9iaWxlJywnTi9BJyl9YFxuIgogICAgICAgICAgICBmIvCfk40gKkNpcmNsZSogICAgICAgIDogYHtwLmdldCgnY2lyY2xlJywnTi9BJyl9YFxuIgogICAgICAgICAgICBmIvCfk6cgKkVtYWlsKiAgICAgICAgIDogYHtwLmdldCgnZW1haWwnLCdOL0EnKX1gXG4iCiAgICAgICAgKQogICAgICAgIGlmIHAuZ2V0KCdpZF9udW1iZXInKSBhbmQgcC5nZXQoJ2lkX251bWJlcicpICE9ICdOL0EnOgogICAgICAgICAgICBmb3VuZF9hYWRoYWFycy5hZGQocC5nZXQoJ2lkX251bWJlcicpKQogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBtc2csIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgIAogICAgaWYgZm91bmRfYWFkaGFhcnM6CiAgICAgICAgc2hvd190aXBfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGxpc3QoZm91bmRfYWFkaGFhcnMpWzBdKQogICAgZWxzZToKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQoKZGVmIGFza19hYWRoYWFyX251bWJlcihtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQKICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi8J+GlCBQbGVhc2UgZW50ZXIgYSAqMTItZGlnaXQqIEFhZGhhYXIgbnVtYmVyOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgIGJvdC5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIHByb2Nlc3NfYWFkaGFhcl9pbmZvX2lucHV0KQoKZGVmIHByb2Nlc3NfYWFkaGFhcl9pbmZvX2lucHV0KG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgbWVzc2FnZS50ZXh0LnN0YXJ0c3dpdGgoJy8nKSBvciBtZXNzYWdlLnRleHQgaW4gWyLwn5SiIE51bSBJbmZvIiwgIvCfhpQgQWRoYXIgSW5mbyIsICLwn5qXIFZlaGljbGUgSW5mbyIsICLwn5qTIENoYWxsYW4gSW5mbyIsICLwn5KsIENoYXQgd2l0aCBEZXZlbG9wZXIiXToKICAgICAgICBib3QucHJvY2Vzc19uZXdfbWVzc2FnZXMoW21lc3NhZ2VdKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgaWYgbm90IChtZXNzYWdlLnRleHQuaXNkaWdpdCgpIGFuZCBsZW4obWVzc2FnZS50ZXh0KSA9PSAxMik6CiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgSW52YWxpZCBBYWRoYWFyIG51bWJlciEgUGxlYXNlIGVudGVyIGEgKjEyLWRpZ2l0KiBBYWRoYWFyIG51bWJlcjoiLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19hYWRoYWFyX2luZm9faW5wdXQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIHNhdmVfdXNlcihtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5mcm9tX3VzZXIudXNlcm5hbWUsIAogICAgICAgICAgICAgIG1lc3NhZ2UuZnJvbV91c2VyLmZpcnN0X25hbWUsIG1lc3NhZ2UuZnJvbV91c2VyLmxhc3RfbmFtZSkKICAgIAogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5SOIEZldGNoaW5nIEFhZGhhYXIgZGV0YWlscy4uLiBQbGVhc2Ugd2FpdCDij7MiKQogICAgCiAgICBkYXRhID0gZmV0Y2hfYWFkaGFhcl9pbmZvX2Zyb21fYXBpKG1lc3NhZ2UudGV4dCkKICAgIAogICAgaWYgImVycm9yIiBpbiBkYXRhOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKdjCBFcnJvcjoge2RhdGFbJ2Vycm9yJ119IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSA9PSAibm9fZGF0YSI6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIHtkYXRhLmdldCgnbWVzc2FnZScsICdObyBkYXRhIGZvdW5kIGZvciB0aGlzIEFhZGhhYXIgbnVtYmVyLicpfSIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpICE9ICJzdWNjZXNzIjoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBObyBkYXRhIGZvdW5kIGZvciB0aGlzIEFhZGhhYXIgbnVtYmVyLiIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgcmVzdWx0cyA9IGRhdGEuZ2V0KCJkYXRhIiwgW10pCiAgICAKICAgIGlmIG5vdCByZXN1bHRzOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIE5vIGRhdGEgZm91bmQgZm9yIHRoaXMgQWFkaGFhciBudW1iZXIuIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgdW5pcXVlX3Jlc3VsdHMgPSBbXQogICAgc2Vlbl9tb2JpbGVzID0gc2V0KCkKICAgIAogICAgIyBGaWx0ZXIgZHVwbGljYXRlIG1vYmlsZSBudW1iZXJzCiAgICBmb3IgcCBpbiByZXN1bHRzOgogICAgICAgIG1vYmlsZSA9IHAuZ2V0KCdtb2JpbGUnLCAnJykKICAgICAgICBpZiBtb2JpbGUgYW5kIG1vYmlsZSBub3QgaW4gc2Vlbl9tb2JpbGVzOgogICAgICAgICAgICBzZWVuX21vYmlsZXMuYWRkKG1vYmlsZSkKICAgICAgICAgICAgdW5pcXVlX3Jlc3VsdHMuYXBwZW5kKHApCiAgICAKICAgIGlmIG5vdCB1bmlxdWVfcmVzdWx0czoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBObyBkYXRhIGZvdW5kIGZvciB0aGlzIEFhZGhhYXIgbnVtYmVyLiIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgICAgICAKICAgIG1zZyA9IGYi8J+ThCAqQWFkaGFhciBJbmZvcm1hdGlvbipcbiIKICAgIG1zZyArPSBmIvCfhpQgKkFhZGhhYXIgTm8qICAgIDogYHttZXNzYWdlLnRleHR9YFxuIgogICAgbXNnICs9IGYi8J+RqCAqTmFtZSogICAgICAgICAgOiBge3VuaXF1ZV9yZXN1bHRzWzBdLmdldCgnbmFtZScsJ04vQScpfWBcbiIKICAgIG1zZyArPSBmIvCfkbQgKkZhdGhlciBOYW1lKiAgIDogYHt1bmlxdWVfcmVzdWx0c1swXS5nZXQoJ2ZhdGhlcl9uYW1lJywnTi9BJyl9YFxuIgogICAgbXNnICs9IGYi8J+PoCAqQWRkcmVzcyogICAgICAgOiBge2Zvcm1hdF9hZGRyZXNzKHVuaXF1ZV9yZXN1bHRzWzBdLmdldCgnYWRkcmVzcycsJ04vQScpKX1gXG5cbiIKICAgIAogICAgbXNnICs9ICLwn5OxICpBc3NvY2lhdGVkIE1vYmlsZSBOdW1iZXJzKlxuXG4iCiAgICAKICAgIGZvciBpLCBwIGluIGVudW1lcmF0ZSh1bmlxdWVfcmVzdWx0cywgMSk6CiAgICAgICAgbXNnICs9IGYiKk51bWJlciB7aX06KlxuIgogICAgICAgIG1zZyArPSBmIvCfk54gKk1vYmlsZSBObyogICAgIDogYHtwLmdldCgnbW9iaWxlJywnTi9BJyl9YFxuIgogICAgICAgIGlmIHAuZ2V0KCdhbHRfbW9iaWxlJykgYW5kIHAuZ2V0KCdhbHRfbW9iaWxlJykgIT0gJ04vQSc6CiAgICAgICAgICAgIG1zZyArPSBmIvCfk7EgKkFsdCBNb2JpbGUqICAgIDogYHtwLmdldCgnYWx0X21vYmlsZScsJ04vQScpfWBcbiIKICAgICAgICBtc2cgKz0gZiLwn5ONICpDaXJjbGUqICAgICAgICA6IGB7cC5nZXQoJ2NpcmNsZScsJ04vQScpfWBcbiIKICAgICAgICBpZiBwLmdldCgnZW1haWwnKSBhbmQgcC5nZXQoJ2VtYWlsJykgIT0gJ04vQSc6CiAgICAgICAgICAgIG1zZyArPSBmIvCfk6cgKkVtYWlsKiAgICAgICAgIDogYHtwLmdldCgnZW1haWwnLCdOL0EnKX1gXG4iCiAgICAgICAgbXNnICs9ICLilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcbiIKICAgIAogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIG1zZywgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKCmRlZiBhc2tfdmVoaWNsZV9yYyhtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQKICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi8J+alyBQbGVhc2UgZW50ZXIgKlZlaGljbGUgUmVnaXN0cmF0aW9uIE51bWJlciogKGUuZy4sIGBIUjI2Q0U3Njc0YCk6IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc192ZWhpY2xlX2lucHV0KQoKZGVmIHByb2Nlc3NfdmVoaWNsZV9pbnB1dChtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQKICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIG1lc3NhZ2UudGV4dC5zdGFydHN3aXRoKCcvJykgb3IgbWVzc2FnZS50ZXh0IGluIFsi8J+UoiBOdW0gSW5mbyIsICLwn4aUIEFkaGFyIEluZm8iLCAi8J+alyBWZWhpY2xlIEluZm8iLCAi8J+akyBDaGFsbGFuIEluZm8iLCAi8J+SrCBDaGF0IHdpdGggRGV2ZWxvcGVyIl06CiAgICAgICAgYm90LnByb2Nlc3NfbmV3X21lc3NhZ2VzKFttZXNzYWdlXSkKICAgICAgICByZXR1cm4KICAgICAgICAKICAgIHJjX251bWJlciA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnVwcGVyKCkKICAgIAogICAgaWYgbm90IHJjX251bWJlcjoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKdjCBJbnZhbGlkIFJDIG51bWJlciEgUGxlYXNlIGVudGVyIGEgdmFsaWQgdmVoaWNsZSByZWdpc3RyYXRpb24gbnVtYmVyOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgICAgICBib3QucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBwcm9jZXNzX3ZlaGljbGVfaW5wdXQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIHNhdmVfdXNlcihtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5mcm9tX3VzZXIudXNlcm5hbWUsIAogICAgICAgICAgICAgIG1lc3NhZ2UuZnJvbV91c2VyLmZpcnN0X25hbWUsIG1lc3NhZ2UuZnJvbV91c2VyLmxhc3RfbmFtZSkKICAgIAogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5qXIEZldGNoaW5nIHZlaGljbGUgZGV0YWlscy4uLiBQbGVhc2Ugd2FpdCDij7MiKQogICAgCiAgICBkYXRhID0gZmV0Y2hfdmVoaWNsZV9pbmZvX2Zyb21fYXBpKHJjX251bWJlcikKICAgIAogICAgaWYgImVycm9yIiBpbiBkYXRhOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKdjCBFcnJvcjoge2RhdGFbJ2Vycm9yJ119IiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSA9PSAiZXJyb3IiOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKdjCB7ZGF0YS5nZXQoJ21lc3NhZ2UnLCAnRmFpbGVkIHRvIGZldGNoIHZlaGljbGUgaW5mb3JtYXRpb24uJyl9IikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgIT0gInN1Y2Nlc3MiOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIE5vIHZlaGljbGUgZGV0YWlscyBmb3VuZCBmb3IgdGhpcyBSQyBudW1iZXIuIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgICAgIAogICAgYWRkcmVzc19kYXRhID0gZGF0YS5nZXQoImFkZHJlc3MiLCB7fSkKICAgIHNvdXJjZSA9IGRhdGEuZ2V0KCJzb3VyY2UiLCAiQVBJIikKICAgIAogICAgbXNnID0gZiLwn5qXICpWZWhpY2xlIEluZm9ybWF0aW9uKiAoU291cmNlOiB7c291cmNlfSlcblxuIgogICAgCiAgICAjIEJhc2ljIEluZm9ybWF0aW9uCiAgICBtc2cgKz0gIvCfk4sgKkJhc2ljIEluZm9ybWF0aW9uKlxuIgogICAgbXNnICs9IGYi8J+UoiAqUmVnaXN0cmF0aW9uKiAgIDogYHtkYXRhLmdldCgncmVnaXN0cmF0aW9uJywgcmNfbnVtYmVyKX1gXG4iCiAgICBtc2cgKz0gZiLinIUgKlN0YXR1cyogICAgICAgICA6IGB7ZGF0YS5nZXQoJ3N1Y2Nlc3MnLCAnTi9BJyl9YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJvd25lcl9uYW1lIik6CiAgICAgICAgbXNnICs9IGYi8J+RpCAqT3duZXIgTmFtZSogICAgIDogYHthZGRyZXNzX2RhdGFbJ293bmVyX25hbWUnXX1gXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoIm1ha2VfbmFtZTIiKSBvciBhZGRyZXNzX2RhdGEuZ2V0KCJtYWtlX25hbWUiKToKICAgICAgICBtYWtlID0gYWRkcmVzc19kYXRhLmdldCgibWFrZV9uYW1lMiIpIG9yIGFkZHJlc3NfZGF0YS5nZXQoIm1ha2VfbmFtZSIpIG9yICJOL0EiCiAgICAgICAgbXNnICs9IGYi8J+PrSAqTWFrZSogICAgICAgICAgIDogYHttYWtlfWBcbiIKICAgIAogICAgaWYgYWRkcmVzc19kYXRhLmdldCgibW9kZWxfbmFtZTIiKSBvciBhZGRyZXNzX2RhdGEuZ2V0KCJtb2RlbF9uYW1lIik6CiAgICAgICAgbW9kZWwgPSBhZGRyZXNzX2RhdGEuZ2V0KCJtb2RlbF9uYW1lMiIpIG9yIGFkZHJlc3NfZGF0YS5nZXQoIm1vZGVsX25hbWUiKSBvciAiTi9BIgogICAgICAgIG1zZyArPSBmIvCfmpkgKk1vZGVsKiAgICAgICAgICA6IGB7bW9kZWx9YFxuIgogICAgCiAgICBtc2cgKz0gIlxuIgogICAgCiAgICAjIFZlaGljbGUgRGV0YWlscwogICAgbXNnICs9ICLwn5SnICpWZWhpY2xlIERldGFpbHMqXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInZlaGljbGVfdHlwZV9wcm9jZXNzZWQiKToKICAgICAgICBtc2cgKz0gZiLwn4+377iPICpWZWhpY2xlIFR5cGUqICAgOiBge2FkZHJlc3NfZGF0YVsndmVoaWNsZV90eXBlX3Byb2Nlc3NlZCddfWBcbiIKICAgIGVsaWYgYWRkcmVzc19kYXRhLmdldCgidmVoaWNsZV90eXBlIik6CiAgICAgICAgbXNnICs9IGYi8J+Pt++4jyAqVmVoaWNsZSBUeXBlKiAgIDogYHthZGRyZXNzX2RhdGFbJ3ZlaGljbGVfdHlwZSddfWBcbiIKICAgIAogICAgaWYgYWRkcmVzc19kYXRhLmdldCgiZnVlbF90eXBlIik6CiAgICAgICAgbXNnICs9IGYi4pu9ICpGdWVsIFR5cGUqICAgICAgOiBge2FkZHJlc3NfZGF0YVsnZnVlbF90eXBlJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJyZWdpc3RyYXRpb25feWVhciIpIGFuZCBhZGRyZXNzX2RhdGEuZ2V0KCJyZWdpc3RyYXRpb25fbW9udGgiKToKICAgICAgICBtc2cgKz0gZiLwn5OFICpSZWdpc3RyYXRpb24qICAgOiBge2FkZHJlc3NfZGF0YVsncmVnaXN0cmF0aW9uX3llYXInXX0te2FkZHJlc3NfZGF0YVsncmVnaXN0cmF0aW9uX21vbnRoJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJyZWdpc3RyYXRpb25fZGF0ZSIpOgogICAgICAgIG1zZyArPSBmIvCfk4YgKlJlZyBEYXRlKiAgICAgICA6IGB7YWRkcmVzc19kYXRhWydyZWdpc3RyYXRpb25fZGF0ZSddfWBcbiIKICAgIAogICAgbXNnICs9ICJcbiIKICAgIAogICAgIyBBZGRyZXNzIEluZm9ybWF0aW9uCiAgICBtc2cgKz0gIvCfk40gKkFkZHJlc3MgSW5mb3JtYXRpb24qXG4iCiAgICAKICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInBlcm1hbmVudF9hZGRyZXNzIik6CiAgICAgICAgbXNnICs9IGYi8J+PoCAqUGVybWFuZW50IEFkZHIqIDogYHthZGRyZXNzX2RhdGFbJ3Blcm1hbmVudF9hZGRyZXNzJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJwcmVzZW50X2FkZHJlc3MiKToKICAgICAgICBtc2cgKz0gZiLwn5ONICpQcmVzZW50IEFkZHIqICAgOiBge2FkZHJlc3NfZGF0YVsncHJlc2VudF9hZGRyZXNzJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJyZWdpc3RyYXRpb25fYWRkcmVzcyIpOgogICAgICAgIG1zZyArPSBmIvCfj6IgKlJlZyBBZGRyZXNzKiAgICA6IGB7YWRkcmVzc19kYXRhWydyZWdpc3RyYXRpb25fYWRkcmVzcyddfWBcbiIKICAgIAogICAgbXNnICs9ICJcbiIKICAgIAogICAgIyBUZWNobmljYWwgRGV0YWlscwogICAgbXNnICs9ICLimpnvuI8gKlRlY2huaWNhbCBEZXRhaWxzKlxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJjaGFzc2lzX251bWJlciIpOgogICAgICAgIG1zZyArPSBmIvCflKkgKkNoYXNzaXMgTm8qICAgICA6IGB7YWRkcmVzc19kYXRhWydjaGFzc2lzX251bWJlciddfWBcbiIKICAgIAogICAgaWYgYWRkcmVzc19kYXRhLmdldCgiZW5naW5lX251bWJlciIpOgogICAgICAgIG1zZyArPSBmIvCflKcgKkVuZ2luZSBObyogICAgICA6IGB7YWRkcmVzc19kYXRhWydlbmdpbmVfbnVtYmVyJ119YFxuIgogICAgCiAgICBpZiBhZGRyZXNzX2RhdGEuZ2V0KCJpc19jb21tZXJjaWFsIikgaXMgbm90IE5vbmU6CiAgICAgICAgY29tbWVyY2lhbCA9ICJZZXMiIGlmIGFkZHJlc3NfZGF0YVsiaXNfY29tbWVyY2lhbCJdIGVsc2UgIk5vIgogICAgICAgIG1zZyArPSBmIvCfj6IgKkNvbW1lcmNpYWwqICAgICA6IGB7Y29tbWVyY2lhbH1gXG4iCiAgICAKICAgICMgSW5zdXJhbmNlIEluZm8KICAgIGlmIGFkZHJlc3NfZGF0YS5nZXQoInByZXZpb3VzX2luc3VyZXIiKToKICAgICAgICBtc2cgKz0gIlxu8J+boe+4jyAqSW5zdXJhbmNlIEluZm8qXG4iCiAgICAgICAgbXNnICs9IGYi8J+PoiAqSW5zdXJlciogICAgICAgIDogYHthZGRyZXNzX2RhdGFbJ3ByZXZpb3VzX2luc3VyZXInXX1gXG4iCiAgICAgICAgCiAgICAgICAgaWYgYWRkcmVzc19kYXRhLmdldCgicHJldmlvdXNfcG9saWN5X2V4cGlyeV9kYXRlIik6CiAgICAgICAgICAgIHN0YXR1cyA9ICLinIUgQWN0aXZlIiBpZiBub3QgYWRkcmVzc19kYXRhLmdldCgicHJldmlvdXNfcG9saWN5X2V4cGlyZWQiLCBUcnVlKSBlbHNlICLinYwgRXhwaXJlZCIKICAgICAgICAgICAgbXNnICs9IGYi8J+ThSAqRXhwaXJ5IERhdGUqICAgIDogYHthZGRyZXNzX2RhdGFbJ3ByZXZpb3VzX3BvbGljeV9leHBpcnlfZGF0ZSddfWBcbiIKICAgICAgICAgICAgbXNnICs9IGYi8J+TiiAqU3RhdHVzKiAgICAgICAgIDogYHtzdGF0dXN9YFxuIgogICAgCiAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQoKZGVmIGFza19jaGFsbGFuX3JjKG1lc3NhZ2UpOgogICAgIyBDaGVjayBpZiB1c2VyIGlzIGJhbm5lZAogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIAogICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5qTIFBsZWFzZSBlbnRlciAqVmVoaWNsZSBSZWdpc3RyYXRpb24gTnVtYmVyKiBmb3IgY2hhbGxhbiBpbmZvIChlLmcuLCBgSFIyNkNFNzY3NGApOiIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgIGJvdC5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIHByb2Nlc3NfY2hhbGxhbl9pbnB1dCkKCmRlZiBwcm9jZXNzX2NoYWxsYW5faW5wdXQobWVzc2FnZSk6CiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYmFubmVkCiAgICBpZiBjaGVja19iYW5fc3RhdHVzKG1lc3NhZ2UuZnJvbV91c2VyLmlkLCBtZXNzYWdlLmNoYXQuaWQpOgogICAgICAgIHJldHVybgogICAgCiAgICBpZiBtZXNzYWdlLnRleHQuc3RhcnRzd2l0aCgnLycpIG9yIG1lc3NhZ2UudGV4dCBpbiBbIvCflKIgTnVtIEluZm8iLCAi8J+GlCBBZGhhciBJbmZvIiwgIvCfmpcgVmVoaWNsZSBJbmZvIiwgIvCfmpMgQ2hhbGxhbiBJbmZvIiwgIvCfkqwgQ2hhdCB3aXRoIERldmVsb3BlciJdOgogICAgICAgIGJvdC5wcm9jZXNzX25ld19tZXNzYWdlcyhbbWVzc2FnZV0pCiAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICByY19udW1iZXIgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS51cHBlcigpCiAgICAKICAgIGlmIG5vdCByY19udW1iZXI6CiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLinYwgSW52YWxpZCBSQyBudW1iZXIhIFBsZWFzZSBlbnRlciBhIHZhbGlkIHZlaGljbGUgcmVnaXN0cmF0aW9uIG51bWJlcjoiLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgYm90LnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19jaGFsbGFuX2lucHV0KQogICAgICAgIHJldHVybgogICAgCiAgICBzYXZlX3VzZXIobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuZnJvbV91c2VyLnVzZXJuYW1lLCAKICAgICAgICAgICAgICBtZXNzYWdlLmZyb21fdXNlci5maXJzdF9uYW1lLCBtZXNzYWdlLmZyb21fdXNlci5sYXN0X25hbWUpCiAgICAKICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi8J+akyBGZXRjaGluZyBjaGFsbGFuIGluZm9ybWF0aW9uLi4uIFBsZWFzZSB3YWl0IOKPsyIpCiAgICAKICAgIGRhdGEgPSBmZXRjaF9jaGFsbGFuX2luZm9fZnJvbV9hcGkocmNfbnVtYmVyKQogICAgCiAgICBpZiAiZXJyb3IiIGluIGRhdGE6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4p2MIEVycm9yOiB7ZGF0YVsnZXJyb3InXX0iLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpID09ICJub19kYXRhIjoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiLinIUgTm8gY2hhbGxhbiByZWNvcmRzIGZvdW5kIGZvciB2ZWhpY2xlOiBge3JjX251bWJlcn1gIikKICAgICAgICBzaG93X21lbnUobWVzc2FnZS5jaGF0LmlkKQogICAgICAgIHJldHVybgogICAgCiAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgIT0gInN1Y2Nlc3MiOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAi4p2MIE5vIGNoYWxsYW4gaW5mb3JtYXRpb24gZm91bmQgZm9yIHRoaXMgUkMgbnVtYmVyLiIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgICAgICAKICAgIGNoYWxsYW5fZGF0YSA9IGRhdGEuZ2V0KCJjaGFsbGFuIiwge30pCiAgICBjaGFsbGFuX2xpc3QgPSBjaGFsbGFuX2RhdGEuZ2V0KCJkYXRhIiwgW10pCiAgICBzb3VyY2UgPSBkYXRhLmdldCgic291cmNlIiwgIkFQSSIpCiAgICAKICAgIGlmIG5vdCBjaGFsbGFuX2xpc3Q6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4pyFIE5vIGNoYWxsYW4gcmVjb3JkcyBmb3VuZCBmb3IgdmVoaWNsZTogYHtyY19udW1iZXJ9YCIpCiAgICAgICAgc2hvd19tZW51KG1lc3NhZ2UuY2hhdC5pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgIyBGaXJzdCwgc2VuZCBzdW1tYXJ5CiAgICB0b3RhbF9jaGFsbGFucyA9IGxlbihjaGFsbGFuX2xpc3QpCiAgICB0b3RhbF9hbW91bnQgPSBzdW0oZmxvYXQoY2hhbGxhbi5nZXQoImFtb3VudCIsIHt9KS5nZXQoInRvdGFsIiwgMCkpIGZvciBjaGFsbGFuIGluIGNoYWxsYW5fbGlzdCBpZiBjaGFsbGFuLmdldCgiYW1vdW50Iiwge30pLmdldCgidG90YWwiKSkKICAgIHBhaWRfY291bnQgPSBzdW0oMSBmb3IgY2hhbGxhbiBpbiBjaGFsbGFuX2xpc3QgaWYgY2hhbGxhbi5nZXQoImNoYWxsYW5fc3RhdHVzIikgPT0gIlBBSUQiKQogICAgdW5wYWlkX2NvdW50ID0gdG90YWxfY2hhbGxhbnMgLSBwYWlkX2NvdW50CiAgICAKICAgIHN1bW1hcnlfbXNnID0gZiLwn5qTICpDaGFsbGFuIFN1bW1hcnkqIChTb3VyY2U6IHtzb3VyY2V9KVxuXG4iCiAgICBzdW1tYXJ5X21zZyArPSBmIvCflKIgKlZlaGljbGUqICAgICAgICA6IGB7ZGF0YS5nZXQoJ3JlZ2lzdHJhdGlvbicsIHJjX251bWJlcil9YFxuIgogICAgc3VtbWFyeV9tc2cgKz0gZiLwn5OKICpUb3RhbCBDaGFsbGFucyogOiBge3RvdGFsX2NoYWxsYW5zfWBcbiIKICAgIHN1bW1hcnlfbXNnICs9IGYi8J+SsCAqVG90YWwgQW1vdW50KiAgIDogYOKCuXt0b3RhbF9hbW91bnQ6LC4yZn1gXG4iCiAgICBzdW1tYXJ5X21zZyArPSBmIuKchSAqUGFpZCogICAgICAgICAgIDogYHtwYWlkX2NvdW50fWBcbiIKICAgIHN1bW1hcnlfbXNnICs9IGYi4p2MICpVbnBhaWQqICAgICAgICAgOiBge3VucGFpZF9jb3VudH1gXG4iCiAgICBzdW1tYXJ5X21zZyArPSBmIvCfk4UgKkZldGNoZWQgT24qICAgICA6IGB7Y2hhbGxhbl9kYXRhLmdldCgnZmV0Y2hlZF9vbicsIGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpKX1gXG5cbiIKICAgIHN1bW1hcnlfbXNnICs9ICLilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcblxuIgogICAgc3VtbWFyeV9tc2cgKz0gIvCfk4sgKkNoYWxsYW4gRGV0YWlscyBCZWxvdzoqXG4iCiAgICAKICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBzdW1tYXJ5X21zZywgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgCiAgICAjIFNlbmQgZWFjaCBjaGFsbGFuIGFzIHNlcGFyYXRlIG1lc3NhZ2UgZm9yIGVhc3kgY29weWluZwogICAgZm9yIGksIGNoYWxsYW4gaW4gZW51bWVyYXRlKGNoYWxsYW5fbGlzdCwgMSk6CiAgICAgICAgY2hhbGxhbl9tc2cgPSBmIvCfmpMgKkNoYWxsYW4ge2l9L3t0b3RhbF9jaGFsbGFuc30qXG5cbiIKICAgICAgICAKICAgICAgICBjaGFsbGFuX21zZyArPSBmIvCfk4QgKkNoYWxsYW4gTm8qICAgIDogYHtjaGFsbGFuLmdldCgnbnVtYmVyJywgJ04vQScpfWBcbiIKICAgICAgICAKICAgICAgICAjIFZpb2xhdGlvbiBkZXRhaWxzCiAgICAgICAgdmlvbGF0aW9ucyA9IGNoYWxsYW4uZ2V0KCJ2aW9sYXRpb25zIiwge30pCiAgICAgICAgaWYgdmlvbGF0aW9uczoKICAgICAgICAgICAgY2hhbGxhbl9tc2cgKz0gZiLwn5OFICpEYXRlKiAgICAgICAgICA6IGB7dmlvbGF0aW9ucy5nZXQoJ2RhdGUnLCAnTi9BJyl9YFxuIgogICAgICAgICAgICBjaGFsbGFuX21zZyArPSBmIvCfkaQgKk5hbWUqICAgICAgICAgIDogYHt2aW9sYXRpb25zLmdldCgnbmFtZScsICdOL0EnKX1gXG4iCiAgICAgICAgICAgIGNoYWxsYW5fbXNnICs9IGYi8J+TjSAqTG9jYXRpb24qICAgICAgOiBge3Zpb2xhdGlvbnMuZ2V0KCdsb2NhdGlvbicsICdOL0EnKX1gXG4iCiAgICAgICAgCiAgICAgICAgIyBBbW91bnQKICAgICAgICBhbW91bnRfZGF0YSA9IGNoYWxsYW4uZ2V0KCJhbW91bnQiLCB7fSkKICAgICAgICBpZiBhbW91bnRfZGF0YToKICAgICAgICAgICAgY2hhbGxhbl9tc2cgKz0gZiLwn5KwICpBbW91bnQqICAgICAgICA6IGDigrl7ZmxvYXQoYW1vdW50X2RhdGEuZ2V0KCd0b3RhbCcsIDApKTosLjJmfWBcbiIKICAgICAgICAKICAgICAgICAjIFN0YXR1cyB3aXRoIGVtb2ppCiAgICAgICAgc3RhdHVzID0gY2hhbGxhbi5nZXQoImNoYWxsYW5fc3RhdHVzIiwgIlVOS05PV04iKQogICAgICAgIHN0YXR1c19lbW9qaSA9ICLinIUiIGlmIHN0YXR1cyA9PSAiUEFJRCIgZWxzZSAi4p2MIiBpZiBzdGF0dXMgPT0gIlVOUEFJRCIgZWxzZSAi4p2TIgogICAgICAgIGNoYWxsYW5fbXNnICs9IGYi8J+TiiAqU3RhdHVzKiAgICAgICAgOiB7c3RhdHVzX2Vtb2ppfSBge3N0YXR1c31gXG4iCiAgICAgICAgCiAgICAgICAgIyBTdGF0ZQogICAgICAgIGlmIGNoYWxsYW4uZ2V0KCJzdGF0ZSIpOgogICAgICAgICAgICBjaGFsbGFuX21zZyArPSBmIvCfj5vvuI8gKlN0YXRlKiAgICAgICAgIDogYHtjaGFsbGFuWydzdGF0ZSddfWBcbiIKICAgICAgICAKICAgICAgICAjIFZpb2xhdGlvbiBvZmZlbmNlcyAobGlzdCBhbGwpCiAgICAgICAgdmlvbGF0aW9uc19saXN0ID0gdmlvbGF0aW9ucy5nZXQoImRldGFpbHMiLCBbXSkKICAgICAgICBpZiB2aW9sYXRpb25zX2xpc3Q6CiAgICAgICAgICAgIGNoYWxsYW5fbXNnICs9ICJcbuKalu+4jyAqVmlvbGF0aW9uczoqXG4iCiAgICAgICAgICAgIGZvciBqLCB2aW9sYXRpb24gaW4gZW51bWVyYXRlKHZpb2xhdGlvbnNfbGlzdCwgMSk6CiAgICAgICAgICAgICAgICBvZmZlbmNlID0gdmlvbGF0aW9uLmdldCgib2ZmZW5jZSIsICJOL0EiKQogICAgICAgICAgICAgICAgY2hhbGxhbl9tc2cgKz0gZiIgIHtqfS4gYHtvZmZlbmNlfWBcbiIKICAgICAgICAKICAgICAgICBjaGFsbGFuX21zZyArPSAiXG7ilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAiCiAgICAgICAgCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGNoYWxsYW5fbXNnLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAKICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCgpkZWYgY2hhdF93aXRoX2RldihtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQKICAgIGlmIGNoZWNrX2Jhbl9zdGF0dXMobWVzc2FnZS5mcm9tX3VzZXIuaWQsIG1lc3NhZ2UuY2hhdC5pZCk6CiAgICAgICAgcmV0dXJuCiAgICAKICAgIG1hcmt1cCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKCkKICAgIGJ0biA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCLwn5KsIE9wZW4gQ2hhdCIsIHVybD1ERVZFTE9QRVJfTElOSykKICAgIG1hcmt1cC5hZGQoYnRuKQogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLwn5SnIFlvdSBjYW4gY29udGFjdCB0aGUgZGV2ZWxvcGVyIGhlcmUg8J+RhyIsIHJlcGx5X21hcmt1cD1tYXJrdXApCgpkZWYgYmFuX3VzZXJfY29tbWFuZChtZXNzYWdlKToKICAgICIiIkhhbmRsZSAvYmFuIGNvbW1hbmQiIiIKICAgIGlmIG1lc3NhZ2UuZnJvbV91c2VyLmlkICE9IEFETUlOX1VTRVJfSUQ6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICLinYwgWW91IGFyZSBub3QgYXV0aG9yaXplZCB0byB1c2UgdGhpcyBjb21tYW5kLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGNvbW1hbmRfcGFydHMgPSBtZXNzYWdlLnRleHQuc3BsaXQoJyAnLCAyKQogICAgaWYgbGVuKGNvbW1hbmRfcGFydHMpIDwgMjoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBQbGVhc2UgcHJvdmlkZSBhIHVzZXIgSUQgdG8gYmFuLlxuVXNhZ2U6IGAvYmFuIDx1c2VyX2lkPiBbcmVhc29uXWAiKQogICAgICAgIHJldHVybgogICAgCiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IGludChjb21tYW5kX3BhcnRzWzFdLnN0cmlwKCkpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBJbnZhbGlkIHVzZXIgSUQuIFBsZWFzZSBwcm92aWRlIGEgbnVtZXJpYyB1c2VyIElELiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIHJlYXNvbiA9IGNvbW1hbmRfcGFydHNbMl0gaWYgbGVuKGNvbW1hbmRfcGFydHMpID4gMiBlbHNlICJObyByZWFzb24gcHJvdmlkZWQiCiAgICAKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBhbHJlYWR5IGJhbm5lZAogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIGYi4p2MIFVzZXIge3VzZXJfaWR9IGlzIGFscmVhZHkgYmFubmVkLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgICMgVHJ5IHRvIGdldCB1c2VyIGluZm8gZnJvbSBkYXRhYmFzZQogICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdCgndXNlcnMuZGInKQogICAgYyA9IGNvbm4uY3Vyc29yKCkKICAgIGMuZXhlY3V0ZSgnU0VMRUNUIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUgRlJPTSB1c2VycyBXSEVSRSB1c2VyX2lkID0gPycsICh1c2VyX2lkLCkpCiAgICB1c2VyX2luZm8gPSBjLmZldGNob25lKCkKICAgIGNvbm4uY2xvc2UoKQogICAgCiAgICB1c2VybmFtZSA9IHVzZXJfaW5mb1swXSBpZiB1c2VyX2luZm8gZWxzZSBOb25lCiAgICBmaXJzdF9uYW1lID0gdXNlcl9pbmZvWzFdIGlmIHVzZXJfaW5mbyBlbHNlICJVbmtub3duIgogICAgbGFzdF9uYW1lID0gdXNlcl9pbmZvWzJdIGlmIHVzZXJfaW5mbyBlbHNlICIiCiAgICAKICAgICMgQmFuIHRoZSB1c2VyCiAgICBiYW5fdXNlcih1c2VyX2lkLCB1c2VybmFtZSwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBtZXNzYWdlLmZyb21fdXNlci5pZCwgcmVhc29uKQogICAgCiAgICAjIFRyeSB0byBzZW5kIG5vdGlmaWNhdGlvbiB0byB0aGUgYmFubmVkIHVzZXIKICAgIHRyeToKICAgICAgICBiYW5fbm90aWZpY2F0aW9uID0gZiLwn5qrIEFDQ09VTlQgQkFOTkVEXG5cbiIKICAgICAgICBiYW5fbm90aWZpY2F0aW9uICs9IGYiWW91ciBhY2NvdW50IGhhcyBiZWVuIGJhbm5lZCBmcm9tIHVzaW5nIHRoaXMgYm90LlxuXG4iCiAgICAgICAgYmFuX25vdGlmaWNhdGlvbiArPSBmIvCflJIgUmVhc29uOiB7cmVhc29ufVxuIgogICAgICAgIGJhbl9ub3RpZmljYXRpb24gKz0gZiLwn5OFIEJhbm5lZCBhdDoge2RhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfVxuXG4iCiAgICAgICAgYmFuX25vdGlmaWNhdGlvbiArPSBmIvCfk54gQ29udGFjdCBPd25lcjogQHtBRE1JTl9VU0VSTkFNRX1cbiIKICAgICAgICBiYW5fbm90aWZpY2F0aW9uICs9IGYi8J+SrCBUZWxlZ3JhbTogaHR0cHM6Ly90Lm1lL3tBRE1JTl9VU0VSTkFNRX1cblxuIgogICAgICAgIGJhbl9ub3RpZmljYXRpb24gKz0gZiLimqDvuI8gSWYgeW91IGJlbGlldmUgdGhpcyBpcyBhIG1pc3Rha2UsIGNvbnRhY3QgdGhlIG93bmVyIHRvIGFwcGVhbC4iCiAgICAgICAgCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSh1c2VyX2lkLCBiYW5fbm90aWZpY2F0aW9uKQogICAgICAgIHVzZXJfbm90aWZpZWQgPSBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgdXNlcl9ub3RpZmllZCA9IEZhbHNlCiAgICAKICAgICMgU2VuZCBjb25maXJtYXRpb24gdG8gYWRtaW4KICAgIGZ1bGxfbmFtZSA9IGYie2ZpcnN0X25hbWV9IHtsYXN0X25hbWV9Ii5zdHJpcCgpIGlmIGZpcnN0X25hbWUgb3IgbGFzdF9uYW1lIGVsc2UgIlVua25vd24gVXNlciIKICAgIHVzZXJfbGluayA9IGYiQHt1c2VybmFtZX0iIGlmIHVzZXJuYW1lIGVsc2UgZiJVc2VyIElEOiB7dXNlcl9pZH0iCiAgICAKICAgIGNvbmZpcm1hdGlvbl9tc2cgPSBmIuKchSBVc2VyIEJhbm5lZCBTdWNjZXNzZnVsbHlcblxuIgogICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfkaQgVXNlcjoge3VzZXJfbGlua31cbiIKICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5ObIE5hbWU6IHtmdWxsX25hbWV9XG4iCiAgICBjb25maXJtYXRpb25fbXNnICs9IGYi8J+GlCBVc2VyIElEOiB7dXNlcl9pZH1cbiIKICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5OdIFJlYXNvbjoge3JlYXNvbn1cbiIKICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5GuIEJhbm5lZCBieTogQWRtaW5cbiIKICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5OFIFRpbWU6IHtkYXRldGltZS5ub3coKS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX1cbiIKICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5SUIFVzZXIgTm90aWZpZWQ6IHsn4pyFIFllcycgaWYgdXNlcl9ub3RpZmllZCBlbHNlICfinYwgTm8gKFVzZXIgbWF5IGhhdmUgYmxvY2tlZCB0aGUgYm90KSd9IgogICAgCiAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgY29uZmlybWF0aW9uX21zZykKCmRlZiB1bmJhbl91c2VyX2NvbW1hbmQobWVzc2FnZSk6CiAgICAiIiJIYW5kbGUgL3VuYmFuIGNvbW1hbmQiIiIKICAgIGlmIG1lc3NhZ2UuZnJvbV91c2VyLmlkICE9IEFETUlOX1VTRVJfSUQ6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICLinYwgWW91IGFyZSBub3QgYXV0aG9yaXplZCB0byB1c2UgdGhpcyBjb21tYW5kLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGNvbW1hbmRfcGFydHMgPSBtZXNzYWdlLnRleHQuc3BsaXQoJyAnLCAxKQogICAgaWYgbGVuKGNvbW1hbmRfcGFydHMpIDwgMjoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBQbGVhc2UgcHJvdmlkZSBhIHVzZXIgSUQgdG8gdW5iYW4uXG5Vc2FnZTogYC91bmJhbiA8dXNlcl9pZD5gIikKICAgICAgICByZXR1cm4KICAgIAogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBpbnQoY29tbWFuZF9wYXJ0c1sxXS5zdHJpcCgpKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICLinYwgSW52YWxpZCB1c2VyIElELiBQbGVhc2UgcHJvdmlkZSBhIG51bWVyaWMgdXNlciBJRC4iKQogICAgICAgIHJldHVybgogICAgCiAgICAjIENoZWNrIGlmIHVzZXIgaXMgYWN0dWFsbHkgYmFubmVkCiAgICBpZiBub3QgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIGYi4p2MIFVzZXIge3VzZXJfaWR9IGlzIG5vdCBiYW5uZWQuIikKICAgICAgICByZXR1cm4KICAgIAogICAgIyBHZXQgdXNlciBpbmZvIGJlZm9yZSB1bmJhbm5pbmcKICAgIGJhbl9pbmZvID0gZ2V0X2Jhbm5lZF91c2VyX2luZm8odXNlcl9pZCkKICAgIAogICAgIyBVbmJhbiB0aGUgdXNlcgogICAgaWYgdW5iYW5fdXNlcih1c2VyX2lkKToKICAgICAgICAjIFRyeSB0byBzZW5kIG5vdGlmaWNhdGlvbiB0byB0aGUgdW5iYW5uZWQgdXNlcgogICAgICAgIHRyeToKICAgICAgICAgICAgdW5iYW5fbm90aWZpY2F0aW9uID0gZiLinIUgQUNDT1VOVCBVTkJBTk5FRFxuXG4iCiAgICAgICAgICAgIHVuYmFuX25vdGlmaWNhdGlvbiArPSBmIllvdXIgYWNjb3VudCBoYXMgYmVlbiB1bmJhbm5lZCBmcm9tIHRoZSBib3QuXG5cbiIKICAgICAgICAgICAgdW5iYW5fbm90aWZpY2F0aW9uICs9IGYi8J+ThSBVbmJhbm5lZCBhdDoge2RhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfVxuXG4iCiAgICAgICAgICAgIHVuYmFuX25vdGlmaWNhdGlvbiArPSBmIvCfjokgWW91IGNhbiBub3cgdXNlIHRoZSBib3QgYWdhaW4hXG4iCiAgICAgICAgICAgIHVuYmFuX25vdGlmaWNhdGlvbiArPSBmIlR5cGUgL3N0YXJ0IHRvIGJlZ2luLiIKICAgICAgICAgICAgCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZCwgdW5iYW5fbm90aWZpY2F0aW9uKQogICAgICAgICAgICB1c2VyX25vdGlmaWVkID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdXNlcl9ub3RpZmllZCA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBTZW5kIGNvbmZpcm1hdGlvbiB0byBhZG1pbgogICAgICAgIHVzZXJuYW1lID0gYmFuX2luZm9bMV0gaWYgYmFuX2luZm8gYW5kIGxlbihiYW5faW5mbykgPiAxIGVsc2UgTm9uZQogICAgICAgIGZpcnN0X25hbWUgPSBiYW5faW5mb1syXSBpZiBiYW5faW5mbyBhbmQgbGVuKGJhbl9pbmZvKSA+IDIgZWxzZSAiVW5rbm93biIKICAgICAgICBsYXN0X25hbWUgPSBiYW5faW5mb1szXSBpZiBiYW5faW5mbyBhbmQgbGVuKGJhbl9pbmZvKSA+IDMgZWxzZSAiIgogICAgICAgIAogICAgICAgIGZ1bGxfbmFtZSA9IGYie2ZpcnN0X25hbWV9IHtsYXN0X25hbWV9Ii5zdHJpcCgpIGlmIGZpcnN0X25hbWUgb3IgbGFzdF9uYW1lIGVsc2UgIlVua25vd24gVXNlciIKICAgICAgICB1c2VyX2xpbmsgPSBmIkB7dXNlcm5hbWV9IiBpZiB1c2VybmFtZSBlbHNlIGYiVXNlciBJRDoge3VzZXJfaWR9IgogICAgICAgIAogICAgICAgIGNvbmZpcm1hdGlvbl9tc2cgPSBmIuKchSBVc2VyIFVuYmFubmVkIFN1Y2Nlc3NmdWxseVxuXG4iCiAgICAgICAgY29uZmlybWF0aW9uX21zZyArPSBmIvCfkaQgVXNlcjoge3VzZXJfbGlua31cbiIKICAgICAgICBjb25maXJtYXRpb25fbXNnICs9IGYi8J+TmyBOYW1lOiB7ZnVsbF9uYW1lfVxuIgogICAgICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn4aUIFVzZXIgSUQ6IHt1c2VyX2lkfVxuIgogICAgICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5GuIFVuYmFubmVkIGJ5OiBBZG1pblxuIgogICAgICAgIGNvbmZpcm1hdGlvbl9tc2cgKz0gZiLwn5OFIFRpbWU6IHtkYXRldGltZS5ub3coKS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX1cbiIKICAgICAgICBjb25maXJtYXRpb25fbXNnICs9IGYi8J+UlCBVc2VyIE5vdGlmaWVkOiB7J+KchSBZZXMnIGlmIHVzZXJfbm90aWZpZWQgZWxzZSAn4p2MIE5vIChVc2VyIG1heSBoYXZlIGJsb2NrZWQgdGhlIGJvdCknfSIKICAgICAgICAKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgY29uZmlybWF0aW9uX21zZykKICAgIGVsc2U6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIGYi4p2MIEZhaWxlZCB0byB1bmJhbiB1c2VyIHt1c2VyX2lkfS4gVGhleSBtYXkgbm90IGJlIGluIHRoZSBiYW5uZWQgbGlzdC4iKQoKZGVmIHNob3dfYmFubmVkX3VzZXJzKG1lc3NhZ2UpOgogICAgIiIiSGFuZGxlIC9iYW5uZWQgY29tbWFuZCB0byBzaG93IGFsbCBiYW5uZWQgdXNlcnMiIiIKICAgIGlmIG1lc3NhZ2UuZnJvbV91c2VyLmlkICE9IEFETUlOX1VTRVJfSUQ6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICLinYwgWW91IGFyZSBub3QgYXV0aG9yaXplZCB0byB1c2UgdGhpcyBjb21tYW5kLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGJhbm5lZF91c2VycyA9IGdldF9hbGxfYmFubmVkX3VzZXJzKCkKICAgIAogICAgaWYgbm90IGJhbm5lZF91c2VyczoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIvCfk4sgQmFubmVkIFVzZXJzIExpc3RcblxuTm8gdXNlcnMgYXJlIGN1cnJlbnRseSBiYW5uZWQuIOKchSIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIG1zZyA9ICLwn5OLIEJhbm5lZCBVc2VycyBMaXN0XG5cbiIKICAgIG1zZyArPSBmIlRvdGFsIGJhbm5lZCB1c2Vyczoge2xlbihiYW5uZWRfdXNlcnMpfVxuXG4iCiAgICAKICAgIGZvciBpLCB1c2VyIGluIGVudW1lcmF0ZShiYW5uZWRfdXNlcnMsIDEpOgogICAgICAgIHVzZXJfaWQsIHVzZXJuYW1lLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIGJhbm5lZF9hdCA9IHVzZXIKICAgICAgICBmdWxsX25hbWUgPSBmIntmaXJzdF9uYW1lfSB7bGFzdF9uYW1lfSIuc3RyaXAoKSBpZiBmaXJzdF9uYW1lIG9yIGxhc3RfbmFtZSBlbHNlICJVbmtub3duIgogICAgICAgIHVzZXJfbGluayA9IGYiQHt1c2VybmFtZX0iIGlmIHVzZXJuYW1lIGVsc2UgZiJJRDoge3VzZXJfaWR9IgogICAgICAgIAogICAgICAgIG1zZyArPSBmIntpfS4ge3VzZXJfbGlua31cbiIKICAgICAgICBtc2cgKz0gZiIgICDwn5GkIE5hbWU6IHtmdWxsX25hbWV9XG4iCiAgICAgICAgbXNnICs9IGYiICAg8J+GlCBJRDoge3VzZXJfaWR9XG4iCiAgICAgICAgbXNnICs9IGYiICAg8J+ThSBCYW5uZWQ6IHtiYW5uZWRfYXR9XG4iCiAgICAgICAgbXNnICs9ICIgICDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcbiIKICAgIAogICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIG1zZykKCmRlZiBicm9hZGNhc3RfbWVzc2FnZShtZXNzYWdlKToKICAgIGlmIG1lc3NhZ2UuZnJvbV91c2VyLmlkICE9IEFETUlOX1VTRVJfSUQ6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICLinYwgWW91IGFyZSBub3QgYXV0aG9yaXplZCB0byB1c2UgdGhpcyBjb21tYW5kLiIpCiAgICAgICAgcmV0dXJuCiAgICAKICAgIGNvbW1hbmRfcGFydHMgPSBtZXNzYWdlLnRleHQuc3BsaXQoJyAnLCAxKQogICAgaWYgbGVuKGNvbW1hbmRfcGFydHMpIDwgMjoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIuKdjCBQbGVhc2UgcHJvdmlkZSBhIG1lc3NhZ2UgdG8gYnJvYWRjYXN0LlxuVXNhZ2U6IGAvbXNnIHlvdXIgbWVzc2FnZSBoZXJlYCIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKICAgICAgICByZXR1cm4KICAgIAogICAgYnJvYWRjYXN0X3RleHQgPSBjb21tYW5kX3BhcnRzWzFdCiAgICBicm9hZGNhc3RfaWQgPSBnZW5lcmF0ZV9icm9hZGNhc3RfaWQoKQogICAgYnJvYWRjYXN0X3N0b3JhZ2VbYnJvYWRjYXN0X2lkXSA9IGJyb2FkY2FzdF90ZXh0CiAgICAKICAgIG1hcmt1cCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKCkKICAgIGNvbmZpcm1fYnRuID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIuKchSBZZXMsIFNlbmQgdG8gQWxsIiwgY2FsbGJhY2tfZGF0YT1mImJjX2NvbmZpcm06e2Jyb2FkY2FzdF9pZH0iKQogICAgY2FuY2VsX2J0biA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCLinYwgQ2FuY2VsIiwgY2FsbGJhY2tfZGF0YT0iYmNfY2FuY2VsIikKICAgIG1hcmt1cC5hZGQoY29uZmlybV9idG4sIGNhbmNlbF9idG4pCiAgICAKICAgIHByZXZpZXdfdGV4dCA9IGJyb2FkY2FzdF90ZXh0WzoxMDBdICsgIi4uLiIgaWYgbGVuKGJyb2FkY2FzdF90ZXh0KSA+IDEwMCBlbHNlIGJyb2FkY2FzdF90ZXh0CiAgICAKICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAKICAgICAgICAgICAgICAgICBmIvCfk6IgQnJvYWRjYXN0IENvbmZpcm1hdGlvblxuXG4iCiAgICAgICAgICAgICAgICAgZiJNZXNzYWdlIFByZXZpZXc6IHtwcmV2aWV3X3RleHR9XG5cbiIKICAgICAgICAgICAgICAgICBmIk1lc3NhZ2UgTGVuZ3RoOiB7bGVuKGJyb2FkY2FzdF90ZXh0KX0gY2hhcmFjdGVyc1xuIgogICAgICAgICAgICAgICAgIGYiVG90YWwgdXNlcnM6IHtsZW4oZ2V0X2FsbF91c2VycygpKX1cblxuIgogICAgICAgICAgICAgICAgIGYiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHNlbmQgdGhpcyBtZXNzYWdlIHRvIGFsbCB1c2Vycz8iLAogICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1tYXJrdXApCgpkZWYgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgYnJvYWRjYXN0X3RleHQpOgogICAgIyBTa2lwIGJhbm5lZCB1c2VycyB3aGVuIGJyb2FkY2FzdGluZwogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIHRyeToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHVzZXJfaWQsIAogICAgICAgICAgICAgICAgICAgICAgIGYi8J+ToiBBbm5vdW5jZW1lbnRcblxue2Jyb2FkY2FzdF90ZXh0fVxuXG4iCiAgICAgICAgICAgICAgICAgICAgICAgZiLilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIBcbiIKICAgICAgICAgICAgICAgICAgICAgICBmIkJvdCBVcGRhdGUg8J+kliIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIEZhbHNlCgpkZWYgc2VuZF9icm9hZGNhc3Rfc2VxdWVudGlhbCh1c2VyX2lkcywgYnJvYWRjYXN0X3RleHQsIGNhbGxiYWNrX21lc3NhZ2UpOgogICAgc3VjY2Vzc19jb3VudCA9IDAKICAgIGZhaWxfY291bnQgPSAwCiAgICB0b3RhbF91c2VycyA9IGxlbih1c2VyX2lkcykKICAgIAogICAgZm9yIGluZGV4LCB1c2VyX2lkIGluIGVudW1lcmF0ZSh1c2VyX2lkcywgMSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCBicm9hZGNhc3RfdGV4dCk6CiAgICAgICAgICAgICAgICBzdWNjZXNzX2NvdW50ICs9IDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZhaWxfY291bnQgKz0gMQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgaW5kZXggJSAxMCA9PSAwIG9yIGluZGV4ID09IHRvdGFsX3VzZXJzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX3BlcmNlbnQgPSAoaW5kZXggLyB0b3RhbF91c2VycykgKiAxMDAKICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja19tZXNzYWdlLmZyb21fdXNlci5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgZiLwn5OKIEJyb2FkY2FzdCBQcm9ncmVzc1xuXG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi8J+UhCBTZW50OiB7aW5kZXh9L3t0b3RhbF91c2Vyc31cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLwn5OIIFByb2dyZXNzOiB7cHJvZ3Jlc3NfcGVyY2VudDouMWZ9JVxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKchSBTdWNjZXNzOiB7c3VjY2Vzc19jb3VudH1cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLinYwgRmFpbGVkOiB7ZmFpbF9jb3VudH0iCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMC4wNSkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgZmFpbF9jb3VudCArPSAxCiAgICAKICAgIHRyeToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjYWxsYmFja19tZXNzYWdlLmZyb21fdXNlci5pZCwKICAgICAgICAgICAgZiLwn5OKIEJyb2FkY2FzdCBDb21wbGV0ZWQhXG5cbiIKICAgICAgICAgICAgZiLinIUgU3VjY2Vzczoge3N1Y2Nlc3NfY291bnR9XG4iCiAgICAgICAgICAgIGYi4p2MIEZhaWxlZDoge2ZhaWxfY291bnR9XG4iCiAgICAgICAgICAgIGYi8J+RpSBUb3RhbDoge3RvdGFsX3VzZXJzfVxuIgogICAgICAgICAgICBmIvCfk50gTWVzc2FnZSBMZW5ndGg6IHtsZW4oYnJvYWRjYXN0X3RleHQpfSBjaGFyYWN0ZXJzXG4iCiAgICAgICAgICAgIGYi4pqhIE1ldGhvZDogU2VxdWVudGlhbCB3aXRoIHByb2dyZXNzIHVwZGF0ZXMiCiAgICAgICAgKQogICAgZXhjZXB0OgogICAgICAgIHBhc3MKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEuc3RhcnRzd2l0aCgnYmNfJykpCmRlZiBoYW5kbGVfYnJvYWRjYXN0X2NvbmZpcm1hdGlvbihjYWxsKToKICAgIGlmIGNhbGwuZGF0YSA9PSAnYmNfY2FuY2VsJzoKICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3RleHQoIuKdjCBCcm9hZGNhc3QgY2FuY2VsbGVkLiIsIGNhbGwubWVzc2FnZS5jaGF0LmlkLCBjYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCkKICAgICAgICByZXR1cm4KICAgIAogICAgaWYgY2FsbC5kYXRhLnN0YXJ0c3dpdGgoJ2JjX2NvbmZpcm06Jyk6CiAgICAgICAgYnJvYWRjYXN0X2lkID0gY2FsbC5kYXRhLnNwbGl0KCdiY19jb25maXJtOicsIDEpWzFdCiAgICAgICAgYnJvYWRjYXN0X3RleHQgPSBicm9hZGNhc3Rfc3RvcmFnZS5nZXQoYnJvYWRjYXN0X2lkKQogICAgICAgIAogICAgICAgIGlmIG5vdCBicm9hZGNhc3RfdGV4dDoKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV90ZXh0KCLinYwgQnJvYWRjYXN0IG1lc3NhZ2UgZXhwaXJlZCBvciBub3QgZm91bmQuIiwgY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGNhbGwubWVzc2FnZS5tZXNzYWdlX2lkKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBpZiBicm9hZGNhc3RfaWQgaW4gYnJvYWRjYXN0X3N0b3JhZ2U6CiAgICAgICAgICAgIGRlbCBicm9hZGNhc3Rfc3RvcmFnZVticm9hZGNhc3RfaWRdCiAgICAgICAgCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV90ZXh0KCLimqEgU2VuZGluZyBicm9hZGNhc3QgdG8gYWxsIHVzZXJzLi4uIiwgY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGNhbGwubWVzc2FnZS5tZXNzYWdlX2lkKQogICAgICAgIAogICAgICAgIHVzZXJzID0gZ2V0X2FsbF91c2VycygpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHVzZXJzOgogICAgICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3RleHQoIuKdjCBObyB1c2VycyBmb3VuZCBpbiBkYXRhYmFzZS4iLCBjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgY2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGJyb2FkY2FzdF90aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKAogICAgICAgICAgICB0YXJnZXQ9c2VuZF9icm9hZGNhc3Rfc2VxdWVudGlhbCwgCiAgICAgICAgICAgIGFyZ3M9KHVzZXJzLCBicm9hZGNhc3RfdGV4dCwgY2FsbCksCiAgICAgICAgICAgIGRhZW1vbj1UcnVlCiAgICAgICAgKQogICAgICAgIGJyb2FkY2FzdF90aHJlYWQuc3RhcnQoKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIGNhbGwuZnJvbV91c2VyLmlkLAogICAgICAgICAgICAgICAgZiLwn5qAIEJyb2FkY2FzdCBTdGFydGVkIVxuXG4iCiAgICAgICAgICAgICAgICBmIvCfk50gTWVzc2FnZSBsZW5ndGg6IHtsZW4oYnJvYWRjYXN0X3RleHQpfSBjaGFyYWN0ZXJzXG4iCiAgICAgICAgICAgICAgICBmIvCfkaUgU2VuZGluZyB0bzoge2xlbih1c2Vycyl9IHVzZXJzXG4iCiAgICAgICAgICAgICAgICBmIuKaoSBNZXRob2Q6IFNlcXVlbnRpYWwgd2l0aCBwcm9ncmVzcyB1cGRhdGVzXG5cbiIKICAgICAgICAgICAgICAgIGYi4o+zIFlvdSB3aWxsIHJlY2VpdmUgcHJvZ3Jlc3MgcmVwb3J0cyBldmVyeSAxMCB1c2Vycy4uLiIKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogVHJ1ZSkKZGVmIGhhbmRsZV9vdGhlcl9tZXNzYWdlcyhtZXNzYWdlKToKICAgICMgQ2hlY2sgaWYgdXNlciBpcyBiYW5uZWQgYmVmb3JlIHNob3dpbmcgbWVudQogICAgaWYgY2hlY2tfYmFuX3N0YXR1cyhtZXNzYWdlLmZyb21fdXNlci5pZCwgbWVzc2FnZS5jaGF0LmlkKToKICAgICAgICByZXR1cm4KICAgIHNob3dfbWVudShtZXNzYWdlLmNoYXQuaWQpCgpkZWYgY2xlYW51cF9icm9hZGNhc3Rfc3RvcmFnZSgpOgogICAgd2hpbGUgVHJ1ZToKICAgICAgICB0aW1lLnNsZWVwKDM2MDApCiAgICAgICAgZ2xvYmFsIGJyb2FkY2FzdF9zdG9yYWdlCiAgICAgICAgYnJvYWRjYXN0X3N0b3JhZ2UgPSB7fQoKY2xlYW51cF90aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1jbGVhbnVwX2Jyb2FkY2FzdF9zdG9yYWdlKQpjbGVhbnVwX3RocmVhZC5kYWVtb24gPSBUcnVlCmNsZWFudXBfdGhyZWFkLnN0YXJ0KCkKCnByaW50KCLwn6SWIEJvdCBpcyBydW5uaW5nICIpCgp3aGlsZSBUcnVlOgogICAgdHJ5OgogICAgICAgIGJvdC5wb2xsaW5nKG5vbmVfc3RvcD1UcnVlKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICB0aW1lLnNsZWVwKDUp').decode('utf-8'))